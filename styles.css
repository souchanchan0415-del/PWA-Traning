/* Train Punch styles — v1.1.2 (perf + import UX)
   - ダーク/ライトテーマ
   - 軽量・視認性微調整
   - color-mix を SRGB 統一
   - スクロール系パフォーマンス小技
   - インポートUI用コンポーネント追加
   - WU関連CSSは削除済み
*/

/* ===== Design tokens ===== */
:root{
  --bg:#0e1116;
  --card:#141922;
  --text:#e8eef6;
  --muted:#a9b4c0;
  --line:#2a3140;
  --primary:#0fb6a9;
  --danger:#e85b5b;
  --success:#16c784;
  --warning:#f59e0b;

  --radius:16px;
  --shadow:0 6px 24px rgba(0,0,0,.25);

  --chart-h:260px;

  color-scheme: dark;
}
html[data-theme="light"]{
  --bg:#f6f7fb;
  --card:#ffffff;
  --text:#1b2430;
  --muted:#5b6a79;
  --line:#e7ebf2;
  --shadow:0 6px 20px rgba(27,36,48,.08);
  color-scheme: light;
}

/* ===== Base ===== */
*{ box-sizing:border-box; }
html,body{ height:100%; }
html{
  scrollbar-gutter: stable both-edges;
  overscroll-behavior-y: contain;
  scroll-behavior:smooth; /* 小技：スクロール体験UP */
}
body{
  margin:0; color:var(--text);
  background: radial-gradient(1200px 600px at 50% -200px, rgba(15,182,169,.07), transparent 60%), var(--bg);
  font:16px/1.5 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif;
  -webkit-font-smoothing: antialiased;
  text-rendering: optimizeLegibility;
  font-variant-numeric: tabular-nums;
}
a{ color:var(--primary); text-decoration:none; }
a:hover{ text-decoration:underline; }

/* ===== Appbar / Tabs ===== */
.appbar{
  position:sticky; top:0; z-index:10; isolation:isolate;
  padding:12px 16px 8px;
  padding-top: calc(12px + env(safe-area-inset-top));
  contain: layout paint; /* 小技：再レイアウト範囲を限定 */

  /* blur は高級感はそのまま、スクロール中は app.js 側で殺す */
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  background:linear-gradient(to bottom, rgba(0,0,0,.28), transparent), var(--bg);
}
.logo{ margin:0 0 10px; font-size:28px; font-weight:800; letter-spacing:.2px; }
.tabs{ display:flex; gap:12px; flex-wrap:wrap; position:relative; z-index:2; }
.tabs button{
  appearance:none; border:1px solid var(--line); cursor:pointer;
  padding:10px 16px; border-radius:999px;
  background:var(--card); color:var(--text); box-shadow:var(--shadow);
  transition: transform .02s, background .15s, border-color .15s, box-shadow .15s;
  -webkit-tap-highlight-color: transparent;
}
.tabs button:hover{ border-color: color-mix(in srgb, var(--primary) 50%, #000 50%); }
.tabs button:active{ transform: translateY(1px); }
.tabs button.active{ background:var(--primary); color:#fff; border-color:transparent; }

/* ===== Layout ===== */
.container{
  max-width:1000px; margin:20px auto 80px; padding:0 16px;
  /* Stickyフッターと共存するため下部マージンを拡張 */
  padding-bottom: calc(96px + env(safe-area-inset-bottom));
}
.card{
  background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:18px;
  box-shadow:var(--shadow); margin:20px 0; position:relative; z-index:0; overflow:visible;

  /* 小技：折りたたみカードの初期描画をサボる */
  content-visibility:auto;
  contain-intrinsic-size: 260px;
}
h3{ margin:0 0 12px; font-size:18px; }

/* ===== Grids / Rows ===== */
.row{ display:flex; gap:12px; align-items:center; margin:10px 0; flex-wrap:wrap; }
.grid{ display:grid; gap:12px; }
.grid-2{ grid-template-columns: 1fr 160px; }
.grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
.end{ justify-content:flex-end; }

/* ===== Inputs & Buttons ===== */
input, select, textarea, button{ font:inherit; color:inherit; }
input:not([type="checkbox"]):not([type="radio"]), select, textarea{
  background:color-mix(in srgb, var(--card) 95%, #000 5%); color:var(--text);
  border:1px solid var(--line); border-radius:12px; padding:12px 14px; min-height:44px;
  flex:1 1 220px; transition:border-color .12s, box-shadow .12s, background .12s;
}
textarea{ resize:vertical; }
input::placeholder, textarea::placeholder{ color: color-mix(in srgb, var(--muted) 90%, #000 10%); }

input:not([type="checkbox"]):not([type="radio"]):focus,
select:focus, textarea:focus{
  border-color: color-mix(in srgb, var(--primary) 80%, #000 20%);
  box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 16%, transparent);
  outline: none;
}
select{ padding-right:40px; }
label{ min-width:56px; color:var(--muted); }
input[type="checkbox"], input[type="radio"]{ accent-color: var(--primary); }

@supports(selector(:has(*))){
  select:has(option[disabled]:checked){ color: var(--muted); }
}

button{
  appearance:none; border:1px solid var(--line); background:var(--primary); color:#fff;
  padding:12px 16px; border-radius:12px; cursor:pointer; min-height:44px;
  transition: filter .1s, transform .02s, background .15s, border-color .15s, box-shadow .15s;
}
button:hover{ filter: brightness(1.02); }
button:active{ transform: translateY(1px); }
button:disabled{ opacity:.55; cursor:not-allowed; filter:none; }
button.ghost{ background:transparent; color:var(--text); }
button.ghost:hover{ border-color: color-mix(in srgb, var(--primary) 55%, #000 45%); }
button.danger{ background:var(--danger); border-color:transparent; color:#fff; }
button.ghost.danger{
  color: var(--danger);
  border-color: color-mix(in srgb, var(--danger) 65%, #000 35%);
  background: transparent;
}
button.ghost.danger:hover{
  border-color: color-mix(in srgb, var(--danger) 85%, #000 15%);
}
.btnlike{
  display:inline-block; padding:12px 16px; border:1px solid var(--line); border-radius:12px; cursor:pointer;
}
.btnlike:hover{ border-color: color-mix(in srgb, var(--primary) 55%, #000 45%); }

/* ===== Chipset ===== */
.chipset{ display:flex; gap:10px; flex-wrap:wrap; position:relative; z-index:2; }
.chip{
  padding:10px 14px; border-radius:999px; border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 94%, #000 6%); color:var(--text); cursor:pointer;
  transition: background .15s, border-color .15s, transform .02s;
}
.chip:hover{ border-color: color-mix(in srgb, var(--primary) 60%, #000 40%); }
.chip:active{ transform: translateY(1px); }
.chip.active{ background:var(--primary); color:#fff; border-color:transparent; }

/* ===== NEW: Part filter chip bar (最小CSS) ===== */
.chipbar{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 6px; }
.chipbar button{
  appearance:none; border:1px solid var(--line);
  background:color-mix(in srgb, var(--card) 94%, #000 6%); color:var(--text);
  padding:8px 12px; border-radius:999px; min-height:36px; cursor:pointer;
}
.chipbar button.is-active{ background:var(--primary); color:#fff; border-color:transparent; }

/* ===== Lists ===== */
.list{ list-style:none; padding:0; margin:0; }
.list li{
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  border-top:1px dashed var(--line); padding:12px 4px;
}
.list li:first-child{ border-top:none; }
.list li > span{ overflow-wrap:anywhere; }
.list li button{ white-space:nowrap; }
.badge{
  display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
  background:color-mix(in srgb, var(--card) 92%, #000 8%); border:1px solid var(--line); font-size:12px;
  font-variant-numeric: tabular-nums;
}

/* 凡例 */
.legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
.legend .chip{ padding:6px 10px; }

/* 情報テーブル */
.kv{ display:grid; grid-template-columns: 140px 1fr; gap:8px; }
.kv > *{ min-width:0; }
.kv a, .kv div:nth-child(2n){ overflow-wrap:anywhere; word-break:break-word; }

/* small */
small, .small{ color:var(--muted); font-size:12.5px; }

/* メトリクス */
#metrics{
  display:grid; grid-template-columns:auto 1fr; gap:6px 12px;
  align-items:center; margin-top:8px; color:var(--muted);
}

/* Switch / checkbox */
.switch{ display:flex; align-items:center; gap:10px; }
.check{ display:flex; align-items:center; gap:10px; }

/* Toast */
.toast{
  position:fixed; left:50%; bottom: calc(18px + env(safe-area-inset-bottom));
  transform:translateX(-50%);
  background:#111c; color:#fff; padding:10px 14px; border-radius:999px; opacity:0;
  pointer-events:none; transition:opacity .18s ease, transform .18s ease;
}
.toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

/* Tabs content */
.tab{
  display:none;
  /* 小技：下タブはスクロール外のときレンダリングを遅延 */
  content-visibility:auto;
  contain-intrinsic-size: 600px;
}
.tab.active{ display:block; }

/* ===== Chart ===== */
#chart, #trendChart{
  width:100%;
  height:var(--chart-h);
  display:block;
  touch-action:none;
  user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
  margin-left:2px;
  image-rendering:-webkit-optimize-contrast;
}

/* === Custom Insert spacing tweaks === */
#tplPartChips{ margin:8px 0 10px; gap:12px; }
#tplPartChips .chip{ padding:9px 14px; }
#tplExCustom{ margin-top:6px; }

/* レイアウト安定化 */
.row > *, .grid > *{ min-width:0; }
.grid-3 input:not([type="checkbox"]):not([type="radio"]), .grid-3 select,
.grid-2 input:not([type="checkbox"]):not([type="radio"]), .grid-2 select{ width:100%; }

/* 種目セレクト行の密着緩和 */
#exSelect { margin-bottom:6px; }

/* ヘッダー右上の丸アイコン */
.iconbtn{
  position:absolute; right:16px; top:12px;
  width:40px; height:40px; border-radius:999px;
  display:inline-flex; align-items:center; justify-content:center;
  background:var(--card); color:var(--text);
  border:1px solid var(--line); box-shadow:var(--shadow);
  font-size:18px; line-height:1; cursor:pointer;
  z-index:3; touch-action:manipulation;
  transition: transform .02s, border-color .15s, background .15s, box-shadow .15s;
}
.iconbtn:hover{ border-color: color-mix(in srgb, var(--primary) 55%, #000 45%); }
.iconbtn:active{ transform:translateY(1px); }
.iconbtn.update{ border-color: color-mix(in srgb, var(--primary) 65%, #000 35%); }
.iconbtn.update::after{
  content:""; position:absolute; right:6px; top:6px;
  width:8px; height:8px; border-radius:999px; background:var(--primary); pointer-events:none;
}
@media (prefers-reduced-motion: no-preference){
  @keyframes tp-blink { 0%, 55% { opacity:1 } 56%, 100% { opacity:.3 } }
  .iconbtn.update::after{ animation: tp-blink 1.6s infinite; }
}

/* アクセシビリティ：フォーカスリング */
:focus-visible{
  outline:2px solid color-mix(in srgb, var(--primary) 80%, #fff 20%);
  outline-offset:2px; border-radius:12px;
}

/* ===== Support page / Ads ===== */
.ad-placeholder{
  border:1px dashed var(--line);
  border-radius:12px;
  min-height:120px;
  display:flex; align-items:center; justify-content:center;
  color:var(--muted);
  font-size:14px;
}

/* === Sticky Save footer === */
.sticky-save{
  position: fixed; left: 0; right: 0; bottom: 0;
  z-index: 999;
  padding: 12px 16px calc(12px + env(safe-area-inset-bottom));
  background: var(--card, #fffffff2);
  border-top: 1px solid var(--line, #e5e7eb);
  backdrop-filter: saturate(1.1) blur(6px);
  -webkit-backdrop-filter: saturate(1.1) blur(6px);
}
@media (prefers-color-scheme: dark){
  .sticky-save{
    background: color-mix(in srgb, #0b1216 85%, transparent);
    border-top-color: #ffffff1a;
  }
}
.sticky-save button{
  width: min(640px, 100%);
  margin: 0 auto; display: block;
}

/* === 折りたたみメモ === */
details.memo{ margin: 8px 0 0; }
details.memo > summary{
  cursor: pointer; user-select: none; font-weight: 600; color: var(--muted, #6b7280);
  padding: 6px 2px; list-style: disclosure-closed;
}
details.memo[open] > summary{ list-style: disclosure-open; margin-bottom: 6px; }
details.memo textarea{ width: 100%; }

/* === Opened feel: one-shot ring highlight (1.2s) === */
@media (prefers-reduced-motion: no-preference){
  .flash-ring{ position:relative; }
  .flash-ring::after{
    content:"";
    position:absolute;
    inset:-6px;
    border:2px solid var(--primary);
    border-radius: calc(var(--radius) + 8px);
    opacity:0;
    pointer-events:none;
    z-index:2;
    animation: tp-flash-ring 1.2s ease-out 1;
  }
  @keyframes tp-flash-ring{
    0%   { opacity:0; transform:scale(.98); }
    20%  { opacity:1; transform:scale(1); }
    100% { opacity:0; transform:scale(1.03); }
  }
}

/* === History details: 下段展開にする（最小変更） === */
#historyList li{
  flex-wrap: wrap;
  align-items: flex-start;
}
#historyList .details{
  flex-basis: 100%;
  width: 100%;
  margin-top: 8px;
}
#historyList .details[hidden]{
  display: none !important;
}

/* === Import UX: インポート専用UIコンポーネント === */
/* 想定HTML：
  <div class="import-section">
    <div class="import-drop" id="importDrop">
      <strong>CSV / JSON をドロップ</strong>
      <div class="import-hint">タップしてファイルを選択することもできます</div>
      <input type="file" id="importFile" />
    </div>
    <div class="import-meta">
      <span class="import-file-name">ファイル未選択</span>
      <span class="import-status"><span class="dot"></span>待機中</span>
    </div>
  </div>
*/
.import-section{
  display:grid;
  gap:10px;
  margin-top:10px;
}
.import-drop{
  border:1px dashed var(--line);
  border-radius:12px;
  padding:14px 12px;
  min-height:72px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  background:color-mix(in srgb, var(--card) 96%, #000 4%);
  text-align:center;
  cursor:pointer;
  transition: border-color .15s, background .15s, transform .02s;
}
.import-drop:hover{
  border-color: color-mix(in srgb, var(--primary) 55%, #000 45%);
}
.import-drop:active{
  transform: translateY(1px);
}
.import-drop.is-dragover{
  border-style:solid;
  border-color: var(--primary);
  background: color-mix(in srgb, var(--primary) 8%, var(--card) 92%);
}
.import-drop strong{
  font-size:14px;
}
.import-hint{
  font-size:12.5px;
  color:var(--muted);
}

/* file input は視覚的には隠すが、ラベルクリックで動く想定 */
.import-section input[type="file"]{
  position:absolute;
  width:1px; height:1px;
  padding:0; margin:-1px;
  border:0; clip:rect(0,0,0,0);
  overflow:hidden;
}

.import-meta{
  display:flex;
  justify-content:space-between;
  gap:10px;
  align-items:center;
  font-size:13px;
  color:var(--muted);
  flex-wrap:wrap;
}
.import-file-name{
  font-weight:500;
  overflow-wrap:anywhere;
}
.import-status{
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.import-status .dot{
  width:8px; height:8px;
  border-radius:999px;
  background:var(--muted);
}
.import-status.ok{
  color:var(--success);
}
.import-status.ok .dot{
  background:var(--success);
}
.import-status.err{
  color:var(--danger);
}
.import-status.err .dot{
  background:var(--danger);
}
.import-status.warn{
  color:var(--warning);
}
.import-status.warn .dot{
  background:var(--warning);
}

/* ===== Responsive ===== */
@media (max-width:700px){
  .grid-2{ grid-template-columns:1fr; }
  .grid-3{ grid-template-columns:1fr 1fr; }
  .grid-3 > :nth-child(3){ grid-column:1 / -1; }
}
@media (max-width:600px){
  .appbar{
    backdrop-filter:none;
    -webkit-backdrop-filter:none;
    background:linear-gradient(to bottom, rgba(0,0,0,.18), transparent), var(--bg);
  }
  body{ background:var(--bg); }

  /* 小技：モバイルで影を削ってペイント負荷軽減 */
  .card, .tabs button, .iconbtn{
    box-shadow:none;
  }
}
@media (max-width:560px){
  #tplPartChips{ gap:10px; margin:6px 0 8px; }
  #tplPartChips .chip{ padding:8px 12px; }
}
@media (max-width:360px){
  .grid-3{ grid-template-columns:1fr; }
}

/* iOS WebView 安全策 */
.container, .card, .chipset { transform:none !important; }
button, select, input { touch-action:manipulation; }

/* デコレーション層はタップをブロックしない */
.appbar::before, .appbar::after,
.card::before, .card::after,
#toast { pointer-events:none; }

/* スタッキング保険 */
#tab-analytics, #tab-session, #tab-history, #tab-settings { position:relative; z-index:0; }

/* 低モーション派生 */
@media (prefers-reduced-motion: reduce){
  *{ transition:none !important; animation:none !important; }
}

/* スクロール中は blur を殺す（app.js が .scrolling を付与） */
body.scrolling .appbar{
  backdrop-filter:none;
  -webkit-backdrop-filter:none;
  background:linear-gradient(to bottom, rgba(0,0,0,.18), transparent), var(--bg);
  transition:none;
}