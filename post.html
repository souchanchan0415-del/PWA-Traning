<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | ブログ記事</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    .blog-post-body {
      font-size: 0.9rem;
      color: #e0e0e0;
      margin-top: 8px;
      white-space: pre-wrap; /* 改行をそのまま表示 */
      line-height: 1.7;
    }
    .post-back-link {
      display: inline-block;
      margin-top: 12px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">Train Punch ブログ（β）</p>
  </header>

  <main class="container">
    <section class="card">
      <h2 id="postTitle" class="card-title">読み込み中...</h2>
      <p id="postDate" style="font-size:0.85rem; color:#a0a3b1; margin-top:4px;"></p>

      <div id="postBody" class="blog-post-body">
        記事を読み込んでいます...
      </div>

      <a href="./blog.html" class="post-back-link">← 記事一覧に戻る</a>
    </section>
  </main>

  <footer class="footer">
    <small>© Train Punch</small>
  </footer>

  <script>
    // URL から slug を取り出す (?slug=welcome など)
    function getSlugFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const slug = params.get('slug');
      return slug || '';
    }

    async function loadPost() {
      const slug = getSlugFromUrl();
      const titleEl = document.getElementById('postTitle');
      const dateEl  = document.getElementById('postDate');
      const bodyEl  = document.getElementById('postBody');

      if (!slug) {
        titleEl.textContent = '記事が見つかりません';
        bodyEl.textContent  = 'URL に slug が指定されていません。';
        return;
      }

      try {
        // 1) 目次(index.json)から該当記事を探す
        const indexRes = await fetch('./posts/index.json');
        if (!indexRes.ok) {
          throw new Error('index.json load error: ' + indexRes.status);
        }
        const list = await indexRes.json();
        const post = Array.isArray(list)
          ? list.find(p => p.slug === slug)
          : null;

        if (!post) {
          titleEl.textContent = '記事が見つかりません';
          bodyEl.textContent  = '指定された記事は、目次(index.json)に存在しません。';
          return;
        }

        // メタ情報を反映
        titleEl.textContent = post.title || '(タイトル未設定)';
        dateEl.textContent  = post.date || '';
        document.title      = `Train Punch | ${post.title || 'ブログ記事'}`;

        // 2) 本文ファイル (/posts/{slug}.txt) を読み込む
        const bodyPath = `./posts/${encodeURIComponent(slug)}.txt`;
        const bodyRes = await fetch(bodyPath);

        if (!bodyRes.ok) {
          bodyEl.textContent =
            `本文の読み込みに失敗しました（HTTP ${bodyRes.status}）。`;
          return;
        }

        const text = await bodyRes.text();

        // ★ここを textContent → innerHTML に変更
        bodyEl.innerHTML = text;
      } catch (err) {
        console.error(err);
        titleEl.textContent = '読み込みエラー';
        dateEl.textContent  = '';
        bodyEl.textContent  = '記事の読み込み中にエラーが発生しました。';
      }
    }

    document.addEventListener('DOMContentLoaded', loadPost);

    // Service Worker (他ページと同じ)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>