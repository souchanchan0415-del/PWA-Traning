<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0e1116">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <!-- HTMLは極力キャッシュさせない -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <title>Train Punch v1.5.6-safari-fix3-sets</title>

  <!-- styles -->
  <link rel="preload" href="styles.css?v=1.5.1" as="style">
  <link rel="stylesheet" href="styles.css?v=1.5.1">
  <noscript><style>noscript{display:block;padding:12px}.nojs{display:block}</style></noscript>

  <!-- 最小フォールバックCSS（SW更新ドット / WUバッジ / デバッグ） -->
  <style>
    .iconbtn.update{position:relative}
    .iconbtn.update::after{
      content:""; position:absolute; top:6px; right:6px; width:8px; height:8px; border-radius:50%;
      background:#ff5a5a; box-shadow:0 0 0 0 rgba(255,90,90,.7); animation:tp-pulse 1.6s infinite;
    }
    @keyframes tp-pulse{0%{box-shadow:0 0 0 0 rgba(255,90,90,.7)}70%{box-shadow:0 0 0 10px rgba(255,90,90,0)}100%{box-shadow:0 0 0 0 rgba(255,90,90,0)}}
    .badge.wu{ padding:2px 6px; border-radius:10px; background:#ffe6e6; color:#b21c1c; font-size:12px }
    @media (prefers-color-scheme: dark){ .badge.wu{ background:#3a1f1f; color:#ffb3b3 } }

    #tp-debug{position:fixed;left:8px;right:8px;bottom:8px;max-height:40vh;overflow:auto;background:#111c;color:#fff;
      font:12px/1.5 system-ui;padding:8px;border-radius:8px;z-index:2147483647;box-shadow:0 8px 30px rgba(0,0,0,.35);display:none}
    #tp-debug b{display:inline-block;margin-right:.5em}
  </style>

  <!-- 強制更新（SW解除＋キャッシュ削除）＆下部デバッグ -->
  <script>
    (function(){
      const q = new URL(location.href).searchParams;
      const has = k => q.has(k) && (q.get(k)==='' || q.get(k)==='1' || q.get(k)==='true');

      function mountDebug(){
        const box = document.createElement('div');
        box.id='tp-debug'; box.innerHTML='<b>Debug</b>（一時表示）';
        document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box),{once:true});
        const show = () => { box.style.display='block'; };
        const esc = s => String(s).replace(/[<&]/g, m => ({'<':'&lt;','&':'&amp;'}[m]));
        window.addEventListener('error', e => { show(); box.innerHTML+='<div>Error: '+esc(e.message)+' @ '+esc(e.filename)+':'+(e.lineno||'')+'</div>'; });
        window.addEventListener('unhandledrejection', e => { show(); box.innerHTML+='<div>Promise: '+esc(e.reason && e.reason.message ? e.reason.message : e.reason)+'</div>'; });
        if (has('debug')) window.addEventListener('load', show, {once:true});
      }
      mountDebug();

      window.__tpHardRefresh = async function(){
        if (window.__tpHRRunning) return;
        window.__tpHRRunning = true;
        const btn = document.getElementById('btnHardRefresh');
        if (btn){ btn.disabled = true; btn.textContent = '更新…'; }
        try{
          if('serviceWorker' in navigator){
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
          }
          if('caches' in window){
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
          }
        }catch(_){}
        location.reload();
      };

      if (has('kill')) {
        const cleanURL = location.href.replace(/([?&])(kill(=1|=true)?)(&|$)/,'$1').replace(/[?&]$/,'');
        history.replaceState(null,'',cleanURL);
        window.__tpHardRefresh();
      }
    })();
  </script>

  <script>console.log('TP index v1.5.6-safari-fix3-sets');</script>
</head>
<body>
  <!-- App bar -->
  <header class="appbar">
    <button id="btnHardRefresh" class="iconbtn" title="更新" aria-label="強制更新" type="button" onclick="window.__tpHardRefresh()">↻</button>
    <h1 class="logo">Train Punch</h1>
    <nav class="tabs" aria-label="Main tabs" role="tablist">
      <button class="active" data-tab="session" aria-selected="true" role="tab" type="button">セッション</button>
      <button data-tab="analytics" aria-selected="false" role="tab" type="button">解析</button>
      <button data-tab="history" aria-selected="false" role="tab" type="button">履歴</button>
      <button data-tab="settings" aria-selected="false" role="tab" type="button">設定</button>
    </nav>
  </header>

  <main class="container">
    <!-- ===== Session ===== -->
    <section id="tab-session" class="tab active" aria-labelledby="セッション" role="tabpanel">
      <div class="card">
        <h3>部位</h3>
        <div id="partChips" class="chipset" role="tablist" aria-label="部位選択">
          <div class="chip active" data-part="胸" role="tab" aria-selected="true" tabindex="0">胸</div>
          <div class="chip" data-part="背中" role="tab" aria-selected="false" tabindex="0">背中</div>
          <div class="chip" data-part="肩" role="tab" aria-selected="false" tabindex="0">肩</div>
          <div class="chip" data-part="脚" role="tab" aria-selected="false" tabindex="0">脚</div>
          <div class="chip" data-part="腕" role="tab" aria-selected="false" tabindex="0">腕</div>
        </div>

        <div class="row">
          <label for="exSelect">種目</label>
          <select id="exSelect" aria-label="種目選択">
            <option value="" disabled selected>（選択する）</option>
          </select>
        </div>

        <!-- 重量 / 回数 / セット数 -->
        <div class="grid grid-3">
          <input id="weight" inputmode="decimal" autocomplete="off"
                 placeholder="重量 kg（例: 40x8x3 もOK）" aria-label="重量">
          <input id="reps"   inputmode="numeric" autocomplete="off"
                 placeholder="回数" aria-label="回数">
          <input id="sets"   inputmode="numeric" autocomplete="off"
                 placeholder="セット数" aria-label="セット数">
        </div>
        <!-- 互換用ダミー（app.js 置換後に削除OK） -->
        <input id="rpe" type="hidden" value="">

        <!-- ウォームアップ自動生成 -->
        <div class="row">
          <label for="wuScheme">ウォームアップ</label>
          <select id="wuScheme" title="自動…回数に応じて強度/筋肥大/持久を自動判定" aria-label="ウォームアップ方式">
            <option value="auto" selected>自動（回数から判定）</option>
            <option value="strength">強度系（3–5回向け）</option>
            <option value="hypertrophy">筋肥大系（6–10回向け）</option>
            <option value="endurance">持久系（12回以上）</option>
          </select>

          <label for="wuRound">丸め</label>
          <select id="wuRound" title="プレートに合わせた丸め" aria-label="丸め単位">
            <option value="2.5" selected>±2.5kg</option>
            <option value="1">±1.0kg</option>
            <option value="0.5">±0.5kg</option>
          </select>

          <button id="btnGenWarmup" class="ghost" title="入力中のトップセットからWUを作成" type="button">↑からウォームアップ自動生成</button>
          <button id="btnClearWarmup" class="ghost danger" title="生成済みWUを削除（種目選択時はその種目のみ）" type="button">WU削除</button>
        </div>

        <div class="row end">
          <!-- 互換のため一時的に残す（非表示）。app.js 置換後に削除OK -->
          <button id="btnTimer" class="ghost" type="button" style="display:none">休憩60s</button>
          <button id="btnUndo" class="ghost" type="button">一手戻す</button>
          <button id="btnAddSet" type="button">セット追加</button>
        </div>

        <ul id="todaySets" class="list" aria-live="polite">
          <li>まだありません</li>
        </ul>
      </div>

      <div class="card">
        <h3>日付・メモ</h3>
        <div class="grid grid-2">
          <input id="sessDate" type="date" aria-label="日付">
          <textarea id="sessNote" rows="2" placeholder="メモ（任意）" aria-label="メモ"></textarea>
        </div>
        <div class="row end">
          <button id="btnSaveSession" type="button">セッション保存</button>
        </div>
      </div>

      <div class="card">
        <h3>カスタム投入</h3>
        <div id="tplPartChips" class="chipset" aria-label="カスタム投入の部位選択">
          <div class="chip active" data-part="胸" tabindex="0">胸</div>
          <div class="chip" data-part="背中" tabindex="0">背中</div>
          <div class="chip" data-part="肩" tabindex="0">肩</div>
          <div class="chip" data-part="脚" tabindex="0">脚</div>
          <div class="chip" data-part="腕" tabindex="0">腕</div>
        </div>
        <div class="grid grid-3">
          <select id="tplExCustom" aria-label="カスタム種目"><option value="">（選択する）</option></select>
          <input id="tplCustomSets"  inputmode="numeric" autocomplete="off" placeholder="セット数（例:5）" aria-label="セット数">
          <input id="tplCustomReps"  inputmode="numeric" autocomplete="off" placeholder="回数（例:5）" aria-label="回数">
          <input id="tplCustomWeight" inputmode="decimal" autocomplete="off" placeholder="重量 kg（例:0）" aria-label="重量">
        </div>
        <div class="row end">
          <button id="btnTplCustom" type="button">投入</button>
        </div>
      </div>
    </section>

    <!-- ===== Analytics ===== -->
    <section id="tab-analytics" class="tab" aria-labelledby="解析" role="tabpanel">
      <div class="card" id="weekly-summary">
        <h3>今週のサマリー</h3>
        <div id="weekly-summary-body" aria-live="polite">計算中…</div>
      </div>

      <div class="card">
        <h3>直近7日の合計ボリューム</h3>
        <canvas id="chart" width="800" height="260" aria-label="7日間ボリューム推移"></canvas>
        <div id="metrics"></div>
        <div id="legend" class="legend"></div>
      </div>

      <div class="card">
        <h3>e1RM トレンド</h3>
        <div class="row">
          <label for="exTrendSelect">種目</label>
          <select id="exTrendSelect">
            <option value="">設定 → ウォッチ種目で追加してください</option>
          </select>
          <label for="trendRange">範囲</label>
          <select id="trendRange">
            <option value="10">最新10</option>
            <option value="20">最新20</option>
            <option value="all">すべて</option>
          </select>
        </div>
        <canvas id="trendChart" width="800" height="260" aria-label="e1RMトレンド"></canvas>
        <div id="trendInfo" class="legend"></div>
        <p id="trendHint" class="small"></p>
      </div>
    </section>

    <!-- ===== History ===== -->
    <section id="tab-history" class="tab" aria-labelledby="履歴" role="tabpanel">
      <div class="card">
        <h3>履歴</h3>
        <div class="row">
          <label for="historyCount">表示件数</label>
          <select id="historyCount">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
          <button id="btnExport" class="ghost" type="button">CSVエクスポート</button>
          <label class="btnlike" for="importFile">CSVインポート</label>
          <input id="importFile" type="file" accept=".csv,text/csv" hidden>
        </div>
        <ul id="historyList" class="list"></ul>
      </div>
    </section>

    <!-- ===== Settings ===== -->
    <section id="tab-settings" class="tab" aria-labelledby="設定" role="tabpanel">
      <div class="card">
        <h3>一般</h3>
        <div class="grid grid-3">
          <!-- 休憩タイマー関連は撤去 -->
          <label class="check"><input id="darkToggle" type="checkbox"> ダークテーマ</label>
          <button id="btnNotif" class="ghost" type="button">通知を許可</button>
        </div>
      </div>

      <div class="card">
        <h3>種目</h3>
        <div class="grid grid-3">
          <input id="newExName" placeholder="種目名（例：懸垂）" autocomplete="off">
          <select id="newExPart">
            <option value="" disabled selected>部位</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
          <button id="btnCreateEx" type="button">追加</button>
        </div>
        <div class="row">
          <label for="filterPart">絞り込み</label>
          <select id="filterPart">
            <option value="all" selected>すべて</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
        </div>
        <ul id="exList" class="list"></ul>
      </div>

      <div class="card">
        <h3>ウォッチ種目（PR通知/e1RMトレンド）</h3>
        <div id="watchPartChips" class="chipset">
          <div class="chip active" data-part="胸" tabindex="0">胸</div>
          <div class="chip" data-part="背中" tabindex="0">背中</div>
          <div class="chip" data-part="肩" tabindex="0">肩</div>
          <div class="chip" data-part="脚" tabindex="0">脚</div>
          <div class="chip" data-part="腕" tabindex="0">腕</div>
        </div>
        <div class="row">
          <select id="watchExSelect"><option value="">（選択する）</option></select>
          <button id="btnWatchAdd" type="button">追加</button>
        </div>
        <ul id="watchList" class="list"></ul>
      </div>

      <div class="card">
        <h3>バックアップ</h3>
        <div class="row">
          <button id="btnExportJson" class="ghost" type="button">JSONエクスポート</button>
          <label class="btnlike" for="jsonIn">JSONインポート</label>
          <input id="jsonIn" type="file" accept="application/json" hidden>
        </div>
      </div>

      <div class="card">
        <h3>サポート & ポリシー</h3>
        <div class="kv">
          <div>問い合わせ</div><div><a href="./contact.html">contact.html</a></div>
          <div>プライバシーポリシー</div><div><a href="./privacy.html">privacy.html</a></div>
          <div>特定商取引法に基づく表記</div><div><a href="./tokusho.html">tokusho.html</a></div>
          <div>サポート</div><div><a href="./support.html">support.html</a></div>
        </div>
        <small>上記ページはオフラインでも表示できるようプリキャッシュします。</small>
      </div>

      <div class="card">
        <h3>危険ゾーン</h3>
        <button id="btnWipe" class="danger" type="button">全データ削除</button>
      </div>
    </section>
  </main>

  <!-- Toast & Debug -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="tp-debug"></div>

  <noscript><p class="nojs">JavaScript を有効にしてください。</p></noscript>

  <!-- scripts（キャッシュバスター更新） -->
  <script defer src="app.js?v=1.5.6-safari-fix3-sets"></script>
  <script defer src="sw-register.js?v=1.5.3"></script>
</body>
</html>