<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0e1116">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" href="icons/icon-180.png">
  <title>Train Punch v1.5.4</title>

  <!-- styles -->
  <link rel="preload" href="styles.css?v=1.5.1" as="style">
  <link rel="stylesheet" href="styles.css?v=1.5.1">
  <noscript><style>noscript{display:block;padding:12px} .nojs{display:block}</style></noscript>

  <!-- audio -->
  <link rel="preload" href="beep.wav" as="audio" type="audio/wav">

  <!-- 最小フォールバックCSS（SW更新ドット / WUバッジ） -->
  <style>
    .iconbtn.update{position:relative}
    .iconbtn.update::after{
      content:""; position:absolute; top:6px; right:6px; width:8px; height:8px; border-radius:50%;
      background:#ff5a5a; box-shadow:0 0 0 0 rgba(255,90,90,.7); animation:tp-pulse 1.6s infinite;
    }
    @keyframes tp-pulse{
      0%{ box-shadow:0 0 0 0 rgba(255,90,90,.7) }
      70%{ box-shadow:0 0 0 10px rgba(255,90,90,0) }
      100%{ box-shadow:0 0 0 0 rgba(255,90,90,0) }
    }
    .badge.wu{ padding:2px 6px; border-radius:10px; background:#ffe6e6; color:#b21c1c; font-size:12px }
    @media (prefers-color-scheme: dark){
      .badge.wu{ background:#3a1f1f; color:#ffb3b3 }
    }
  </style>

  <!-- フォールバック：app.jsが読めなくても動くハードリフレッシュ -->
  <script>
  window.__tpHardRefresh = async function(){
    if (window.__tpHRRunning) return;
    window.__tpHRRunning = true;
    const btn = document.getElementById('btnHardRefresh');
    if (btn){ btn.disabled = true; btn.textContent = '更新…'; }
    try{
      if('serviceWorker' in navigator){
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister().catch(()=>{})));
      }
      if('caches' in window){
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k).catch(()=>{})));
      }
    }catch(e){}
    location.reload();
  };
  </script>
</head>
<body>
  <!-- App bar -->
  <header class="appbar">
    <button id="btnHardRefresh" class="iconbtn" title="更新" aria-label="強制更新" type="button" onclick="window.__tpHardRefresh()">↻</button>
    <h1 class="logo">Train Punch</h1>
    <nav class="tabs" aria-label="Main tabs">
      <button class="active" data-tab="session" aria-selected="true">セッション</button>
      <button data-tab="analytics" aria-selected="false">解析</button>
      <button data-tab="history" aria-selected="false">履歴</button>
      <button data-tab="settings" aria-selected="false">設定</button>
    </nav>
  </header>

  <main class="container">
    <!-- ===== Session ===== -->
    <section id="tab-session" class="tab active" aria-labelledby="セッション">
      <div class="card">
        <h3>部位</h3>
        <div id="partChips" class="chipset" role="tablist" aria-label="部位選択">
          <div class="chip active" data-part="胸">胸</div>
          <div class="chip" data-part="背中">背中</div>
          <div class="chip" data-part="肩">肩</div>
          <div class="chip" data-part="脚">脚</div>
          <div class="chip" data-part="腕">腕</div>
        </div>

        <div class="row">
          <label for="exSelect">種目</label>
          <select id="exSelect" aria-label="種目選択">
            <option value="" disabled selected>（選択する）</option>
          </select>
          <!-- セッション側の「＋ 種目追加」は削除（追加は設定タブで実施） -->
        </div>

        <div class="grid grid-3">
          <input id="weight" inputmode="decimal" autocomplete="off" placeholder="重量 kg（例: 40x8@8 もOK）" aria-label="重量">
          <input id="reps"   inputmode="numeric" autocomplete="off" placeholder="回数" aria-label="回数">
          <input id="rpe"    inputmode="decimal" autocomplete="off" placeholder="RPE（任意）" aria-label="RPE">
        </div>

        <!-- ★ ウォームアップ自動生成 -->
        <div class="row">
          <label for="wuScheme">ウォームアップ</label>
          <select id="wuScheme" title="自動…回数に応じて強度/筋肥大/持久を自動判定" aria-label="ウォームアップ方式">
            <option value="auto" selected>自動（回数から判定）</option>
            <option value="strength">強度系（3–5回向け）</option>
            <option value="hypertrophy">筋肥大系（6–10回向け）</option>
            <option value="endurance">持久系（12回以上）</option>
          </select>

          <label for="wuRound">丸め</label>
          <select id="wuRound" title="プレートに合わせた丸め" aria-label="丸め単位">
            <option value="2.5" selected>±2.5kg</option>
            <option value="1">±1.0kg</option>
            <option value="0.5">±0.5kg</option>
          </select>

          <button id="btnGenWarmup" class="ghost" title="入力中のトップセットからWUを作成">↑からウォームアップ自動生成</button>
          <button id="btnClearWarmup" class="ghost danger" title="生成済みWUを削除（種目選択時はその種目のみ）">WU削除</button>
        </div>
        <!-- ／ウォームアップここまで -->

        <div class="row end">
          <button id="btnTimer" class="ghost">休憩60s</button>
          <button id="btnUndo" class="ghost">一手戻す</button>
          <button id="btnAddSet">セット追加</button>
        </div>

        <ul id="todaySets" class="list" aria-live="polite">
          <li>まだありません</li>
        </ul>
      </div>

      <div class="card">
        <h3>日付・メモ</h3>
        <div class="grid grid-2">
          <input id="sessDate" type="date" aria-label="日付">
          <textarea id="sessNote" rows="2" placeholder="メモ（任意）" aria-label="メモ"></textarea>
        </div>
        <div class="row end">
          <button id="btnSaveSession">セッション保存</button>
        </div>
      </div>

      <div class="card">
        <h3>カスタム投入</h3>
        <div id="tplPartChips" class="chipset" aria-label="カスタム投入の部位選択">
          <div class="chip active" data-part="胸">胸</div>
          <div class="chip" data-part="背中">背中</div>
          <div class="chip" data-part="肩">肩</div>
          <div class="chip" data-part="脚">脚</div>
          <div class="chip" data-part="腕">腕</div>
        </div>
        <div class="grid grid-3">
          <select id="tplExCustom" aria-label="カスタム種目"><option value="">（選択する）</option></select>
          <input id="tplCustomSets"  inputmode="numeric" autocomplete="off" placeholder="セット数（例:5）" aria-label="セット数">
          <input id="tplCustomReps"  inputmode="numeric" autocomplete="off" placeholder="回数（例:5）" aria-label="回数">
          <input id="tplCustomWeight" inputmode="decimal" autocomplete="off" placeholder="重量 kg（例:0）" aria-label="重量">
        </div>
        <div class="row end">
          <button id="btnTplCustom">投入</button>
        </div>
      </div>
    </section>

    <!-- ===== Analytics ===== -->
    <section id="tab-analytics" class="tab" aria-labelledby="解析">
      <div class="card" id="weekly-summary">
        <h3>今週のサマリー</h3>
        <div id="weekly-summary-body" aria-live="polite">計算中…</div>
      </div>

      <div class="card">
        <h3>直近7日の合計ボリューム</h3>
        <canvas id="chart" width="800" height="260" aria-label="7日間ボリューム推移"></canvas>
        <div id="metrics"></div>
        <div id="legend" class="legend"></div>
      </div>

      <div class="card">
        <h3>e1RM トレンド</h3>
        <div class="row">
          <label for="exTrendSelect">種目</label>
          <select id="exTrendSelect">
            <option value="">設定 → ウォッチ種目で追加してください</option>
          </select>
          <label for="trendRange">範囲</label>
          <select id="trendRange">
            <option value="10">最新10</option>
            <option value="20">最新20</option>
            <option value="all">すべて</option>
          </select>
        </div>
        <canvas id="trendChart" width="800" height="260" aria-label="e1RMトレンド"></canvas>
        <div id="trendInfo" class="legend"></div>
        <p id="trendHint" class="small"></p>
      </div>
    </section>

    <!-- ===== History ===== -->
    <section id="tab-history" class="tab" aria-labelledby="履歴">
      <div class="card">
        <h3>履歴</h3>
        <div class="row">
          <label for="historyCount">表示件数</label>
          <select id="historyCount">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
          <button id="btnExport" class="ghost">CSVエクスポート</button>
          <label class="btnlike" for="importFile">CSVインポート</label>
          <input id="importFile" type="file" accept=".csv,text/csv" hidden>
        </div>
        <ul id="historyList" class="list"></ul>
      </div>
    </section>

    <!-- ===== Settings ===== -->
    <section id="tab-settings" class="tab" aria-labelledby="設定">
      <div class="card">
        <h3>一般</h3>
        <div class="grid grid-3">
          <label for="timerSec">休憩(秒)</label>
          <select id="timerSec">
            <option>30</option><option selected>60</option><option>90</option><option>120</option>
          </select>
          <label class="check"><input id="autoTimer" type="checkbox"> セット追加で自動スタート</label>
          <label class="check"><input id="darkToggle" type="checkbox"> ダークテーマ</label>
          <button id="btnNotif" class="ghost">通知を許可</button>
        </div>
      </div>

      <div class="card">
        <h3>種目</h3>
        <div class="grid grid-3">
          <input id="newExName" placeholder="種目名（例：懸垂）">
          <select id="newExPart">
            <option value="" disabled selected>部位</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
          <button id="btnCreateEx">追加</button>
        </div>
        <div class="row">
          <label for="filterPart">絞り込み</label>
          <select id="filterPart">
            <option value="all" selected>すべて</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
        </div>
        <ul id="exList" class="list"></ul>
      </div>

      <div class="card">
        <h3>ウォッチ種目（PR通知/e1RMトレンド）</h3>
        <div id="watchPartChips" class="chipset">
          <div class="chip active" data-part="胸">胸</div>
          <div class="chip" data-part="背中">背中</div>
          <div class="chip" data-part="肩">肩</div>
          <div class="chip" data-part="脚">脚</div>
          <div class="chip" data-part="腕">腕</div>
        </div>
        <div class="row">
          <select id="watchExSelect"><option value="">（選択する）</option></select>
          <button id="btnWatchAdd">追加</button>
        </div>
        <ul id="watchList" class="list"></ul>
      </div>

      <div class="card">
        <h3>バックアップ</h3>
        <div class="row">
          <button id="btnExportJson" class="ghost">JSONエクスポート</button>
          <label class="btnlike" for="jsonIn">JSONインポート</label>
          <input id="jsonIn" type="file" accept="application/json" hidden>
        </div>
      </div>

      <div class="card">
        <h3>サポート & ポリシー</h3>
        <div class="kv">
          <div>問い合わせ</div><div><a href="./contact.html">contact.html</a></div>
          <div>プライバシーポリシー</div><div><a href="./privacy.html">privacy.html</a></div>
          <div>特定商取引法に基づく表記</div><div><a href="./tokusho.html">tokusho.html</a></div>
          <div>サポート</div><div><a href="./support.html">support.html</a></div>
        </div>
        <small>上記ページはオフラインでも表示できるようプリキャッシュします。</small>
      </div>

      <div class="card">
        <h3>危険ゾーン</h3>
        <button id="btnWipe" class="danger">全データ削除</button>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <noscript>
    <p class="nojs">JavaScript を有効にしてください。</p>
  </noscript>

  <!-- scripts -->
  <script defer src="app.js?v=1.5.4"></script>
  <script defer src="sw-register.js?v=1.5.2"></script>
</body>
</html>