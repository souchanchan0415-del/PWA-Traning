<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="theme-color" content="#0e1116">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light dark">

  <!-- PWA meta -->
  <meta name="application-name" content="Train Punch">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Train Punch">
  <meta name="description" content="セット・重量・回数・RPEを素早く記録し、週次サマリーやe1RMトレンドを可視化するPWA筋トレログアプリ。">

  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="icons/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png">

  <title>Train Punch v1.1.1</title>

  <!-- styles -->
  <link rel="preload" href="styles.css?v=1.1.1" as="style">
  <link rel="stylesheet" href="styles.css?v=1.1.1">
  <noscript><style>noscript{display:block;padding:12px}.nojs{display:block}</style></noscript>

  <!-- audio（将来用にプリロードだけ） -->
  <link rel="preload" href="beep.wav" as="audio" type="audio/wav">

  <!-- 最小フォールバックCSS（SW更新ドット / セット+RPEの双子枠 / リング演出） -->
  <style>
    .iconbtn.update{position:relative}
    .iconbtn.update::after{
      content:""; position:absolute; top:6px; right:6px; width:8px; height:8px; border-radius:50%;
      background:#ff5a5a; box-shadow:0 0 0 0 rgba(255,90,90,.7); animation:tp-pulse 1.6s infinite;
    }
    @keyframes tp-pulse{
      0%{box-shadow:0 0 0 0 rgba(255,90,90,.7)}
      70%{box-shadow:0 0 0 10px rgba(255,90,90,0)}
      100%{box-shadow:0 0 0 0 rgba(255,90,90,0)}
    }

    #tp-debug{
      position:fixed;left:8px;right:8px;bottom:8px;max-height:40vh;overflow:auto;background:#111c;color:#fff;
      font:12px/1.5 system-ui;padding:8px;border-radius:8px;z-index:2147483647;box-shadow:0 8px 30px rgba(0,0,0,.35);display:none
    }

    /* セット数 + RPE を横並びにする軽量CSS */
    .twins{display:flex;gap:8px}
    .twins>input{flex:1;min-width:0}

    /* リング・ハイライトの簡易フォールバック（styles.cssにも定義あり） */
    @keyframes tp-once-ring {
      0% { box-shadow:0 0 0 0 rgba(15,182,169,.28) }
      80% { box-shadow:0 0 0 8px rgba(15,182,169,.0) }
      100%{ box-shadow:none }
    }
    .flash-ring{
      position:relative;
      animation: tp-once-ring 1.2s ease-out 1;
      outline: 2px solid rgba(15,182,169,.35);
      outline-offset: 2px;
      border-radius: 14px;
    }
  </style>

  <script>console.log('TP index v1.1.1 loaded');</script>
</head>
<body>
  <!-- App bar -->
  <header class="appbar">
    <button id="btnHardRefresh" class="iconbtn" title="更新" aria-label="強制更新" type="button">↻</button>
    <h1 class="logo">Train Punch</h1>
    <nav class="tabs" aria-label="Main tabs" role="tablist">
      <button class="active" data-tab="session" aria-selected="true" aria-current="page" role="tab" type="button">セッション</button>
      <button data-tab="analytics" aria-selected="false" role="tab" type="button">解析</button>
      <button data-tab="history" aria-selected="false" role="tab" type="button">履歴</button>
      <button data-tab="settings" aria-selected="false" role="tab" type="button">設定</button>
    </nav>
  </header>

  <main class="container">
    <!-- ===== Session ===== -->
    <section id="tab-session" class="tab active" aria-labelledby="セッション" role="tabpanel">
      <div class="card">
        <h3>セッション</h3>

        <!-- 日付 -->
        <div class="row">
          <input id="sessDate" type="date" aria-label="日付">
        </div>

        <!-- 部位 -->
        <div>
          <h4 class="subtle">部位</h4>
          <div id="partChips" class="chipset" role="tablist" aria-label="部位選択">
            <div class="chip active" data-part="胸" role="tab" aria-selected="true" tabindex="0">胸</div>
            <div class="chip" data-part="背中" role="tab" aria-selected="false" tabindex="0">背中</div>
            <div class="chip" data-part="肩" role="tab" aria-selected="false" tabindex="0">肩</div>
            <div class="chip" data-part="脚" role="tab" aria-selected="false" tabindex="0">脚</div>
            <div class="chip" data-part="腕" role="tab" aria-selected="false" tabindex="0">腕</div>
          </div>
        </div>

        <!-- 種目 -->
        <div class="row">
          <label for="exSelect">種目</label>
          <select id="exSelect" aria-label="種目選択">
            <option value="" disabled selected>（選択する）</option>
          </select>
        </div>

        <!-- 入力欄：重量 / 回数 / （セット数 + RPE） -->
        <div class="grid grid-3">
          <input id="weight" inputmode="decimal" autocomplete="off" placeholder="重量 kg（例: 40x8x3@8 もOK）" aria-label="重量">
          <input id="reps"   inputmode="numeric" autocomplete="off" placeholder="回数" aria-label="回数">
          <div class="twins">
            <input id="sets" inputmode="numeric" autocomplete="off" placeholder="セット数" aria-label="セット数">
            <input id="rpe"  inputmode="decimal" autocomplete="off" placeholder="RPE（疲労度）" aria-label="RPE（疲労度）">
          </div>
        </div>

        <!-- ▼ 折りたたみメモ（WU削除に伴い直下に配置） -->
        <details id="memoDetails" class="memo">
          <summary>メモを追加</summary>
          <textarea id="sessNote" rows="2" placeholder="メモ（任意）" aria-label="メモ"></textarea>
        </details>

        <!-- ▼ クイック投入（tpl*：app.jsのapplyCustomInsert系と一致） -->
        <div class="card" style="margin-top:12px">
          <h3>クイック投入</h3>
          <div id="tplPartChips" class="chipset" aria-label="クイック投入の部位選択">
            <div class="chip active" data-part="胸" tabindex="0">胸</div>
            <div class="chip" data-part="背中" tabindex="0">背中</div>
            <div class="chip" data-part="肩" tabindex="0">肩</div>
            <div class="chip" data-part="脚" tabindex="0">脚</div>
            <div class="chip" data-part="腕" tabindex="0">腕</div>
          </div>
          <div class="grid grid-3">
            <select id="tplExCustom" aria-label="種目（クイック投入）"><option value="">（種目を選ぶ）</option></select>
            <input id="tplCustomSets" inputmode="numeric" autocomplete="off" placeholder="セット数（例:5）" aria-label="セット数（クイック）">
            <input id="tplCustomReps" inputmode="numeric" autocomplete="off" placeholder="回数（例:5）" aria-label="回数（クイック）">
          </div>
          <div class="row">
            <label for="tplCustomWeight">重量</label>
            <input id="tplCustomWeight" inputmode="decimal" autocomplete="off" placeholder="重量 kg（例: 40）" aria-label="重量（クイック）">
            <button id="btnTplCustom" type="button">カスタム投入</button>
          </div>
          <small class="small">※ 選んだ種目に同じセット×回数×重量を一括で投入します。</small>
        </div>

        <!-- 追加／Undo -->
        <div class="row end">
          <button id="btnUndo" class="ghost" type="button">一手戻す</button>
          <button id="btnAddSet" type="button">セット追加</button>
        </div>

        <!-- 今日のセット -->
        <ul id="todaySets" class="list" aria-live="polite">
          <li>まだありません</li>
        </ul>
      </div>
    </section>

    <!-- ===== Analytics ===== -->
    <section id="tab-analytics" class="tab" aria-labelledby="解析" role="tabpanel">
      <div class="card" id="weekly-summary">
        <h3>今週のサマリー</h3>
        <div id="weekly-summary-body" aria-live="polite">計算中…</div>
      </div>

      <div class="card">
        <h3>直近7日の合計ボリューム</h3>
        <canvas id="chart" width="800" height="260" aria-label="7日間ボリューム推移"></canvas>
        <div id="metrics"></div>
        <div id="legend" class="legend"></div>
      </div>

      <div class="card">
        <h3>e1RM トレンド</h3>
        <div class="row">
          <label for="exTrendSelect">種目</label>
          <select id="exTrendSelect">
            <option value="">設定 → ウォッチ種目で追加してください</option>
          </select>
          <label for="trendRange">範囲</label>
          <select id="trendRange">
            <option value="10">最新10</option>
            <option value="20">最新20</option>
            <option value="all">すべて</option>
          </select>
        </div>
        <canvas id="trendChart" width="800" height="260" aria-label="e1RMトレンド"></canvas>
        <div id="trendInfo" class="legend"></div>
        <p id="trendHint" class="small"></p>
      </div>
    </section>

    <!-- ===== History ===== -->
    <section id="tab-history" class="tab" aria-labelledby="履歴" role="tabpanel">
      <div class="card">
        <h3>履歴</h3>
        <div class="row">
          <label for="historyCount">表示件数</label>
          <select id="historyCount">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
          <button id="btnExport" class="ghost" type="button">CSVエクスポート</button>
          <label class="btnlike" for="importFile">CSVインポート</label>
          <input id="importFile" type="file" accept=".csv,text/csv" hidden>
        </div>
        <ul id="historyList" class="list"></ul>
      </div>
    </section>

    <!-- ===== Settings ===== -->
    <section id="tab-settings" class="tab" aria-labelledby="設定" role="tabpanel">
      <div class="card">
        <h3>一般</h3>
        <div class="grid grid-3">
          <label class="check"><input id="darkToggle" type="checkbox"> ダークテーマ</label>
          <button id="btnNotif" class="ghost" type="button">通知を許可</button>
        </div>
      </div>

      <div class="card">
        <h3>種目</h3>

        <!-- ▼ 追加：部位フィルタ用のチップバー（中身はJSで生成） -->
        <div id="partFilter" class="chipbar" role="group" aria-label="部位フィルタ"></div>

        <div class="grid grid-3">
          <input id="newExName" placeholder="種目名（例：懸垂）" autocomplete="off">
          <select id="newExPart">
            <option value="" disabled selected>部位</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
          <button id="btnCreateEx" type="button">追加</button>
        </div>

        <div class="row">
          <label for="filterPart">絞り込み</label>
          <select id="filterPart">
            <option value="all" selected>すべて</option>
            <option>胸</option><option>背中</option><option>肩</option><option>脚</option><option>腕</option>
          </select>
        </div>

        <ul id="exList" class="list"></