<!DOCTYPE html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, interactive-widget=resizes-content" />
  <title>Train Punch — 筋トレロガー</title>

  <meta name="description" content="サクッと記録できる筋トレロガー。オフライン対応・PWA。" />
  <meta name="theme-color" content="#111111" />
  <meta name="format-detection" content="telephone=no, email=no, address=no" />
  <meta name="color-scheme" content="light dark" />

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="icons/icon-180.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Train Punch" />

  <link rel="preload" href="beep.wav" as="audio" />
  <link rel="prefetch" href="support.html" />
  <!-- CSS のキャッシュバスターは 1.4.3b に統一 -->
  <link rel="stylesheet" href="styles.css?v=1.4.3b" />
</head>
<body>
  <noscript>
    <div style="padding:12px; background:#ffefc2; color:#5a4100; text-align:center;">
      このアプリはJavaScriptが必要です。ブラウザ設定で有効にしてください。
    </div>
  </noscript>

  <header class="appbar">
    <h1 class="logo">Train Punch</h1>
    <button id="btnHardRefresh" class="iconbtn" type="button"
            aria-label="キャッシュをクリアして再読込" title="キャッシュをクリアして再読込">↻</button>

    <nav class="tabs" role="tablist" aria-label="Main tabs">
      <button id="tabbtn-session"  data-tab="session"  class="active" role="tab" aria-selected="true"  aria-controls="tab-session"  type="button">セッション</button>
      <button id="tabbtn-history"  data-tab="history"  role="tab" aria-selected="false" aria-controls="tab-history"  type="button">履歴</button>
      <button id="tabbtn-analytics"data-tab="analytics"role="tab" aria-selected="false" aria-controls="tab-analytics"type="button">分析</button>
      <button id="tabbtn-settings" data-tab="settings" role="tab" aria-selected="false" aria-controls="tab-settings" type="button">設定</button>
    </nav>
  </header>

  <main class="container">
    <!-- ===== セッション ===== -->
    <section id="tab-session" class="tab active" role="tabpanel" aria-labelledby="tabbtn-session">
      <div class="card">
        <div class="row">
          <label for="sessDate">日付</label>
          <input id="sessDate" type="date" autocomplete="off" />
        </div>
        <div class="row">
          <label for="sessNote">メモ</label>
          <input id="sessNote" placeholder="任意メモ" autocomplete="off" enterkeyhint="done" />
        </div>

        <div class="row">
          <label>部位</label>
          <div id="partChips" class="chipset" aria-label="部位の選択">
            <button class="chip" data-part="胸" type="button">胸</button>
            <button class="chip" data-part="背中" type="button">背中</button>
            <button class="chip" data-part="肩" type="button">肩</button>
            <button class="chip" data-part="脚" type="button">脚</button>
            <button class="chip" data-part="腕" type="button">腕</button>
          </div>
        </div>

        <div class="row">
          <label for="exSelect">種目</label>
          <select id="exSelect" aria-label="種目を選択">
            <option value="" selected disabled>（選択する）</option>
          </select>
          <button id="btnAddEx" class="ghost" type="button">＋追加</button>
        </div>

        <div class="grid grid-3">
          <input id="weight" inputmode="decimal" placeholder="重量(kg)" autocomplete="off" enterkeyhint="next" />
          <input id="reps"   inputmode="numeric" placeholder="回数"     autocomplete="off" enterkeyhint="next" />
          <input id="rpe"    inputmode="decimal" placeholder="RPE(任意)"autocomplete="off" enterkeyhint="done" />
        </div>

        <div class="row">
          <button id="btnAddSet" type="button">セット追加</button>
          <button id="btnTimer" class="ghost" type="button">休憩60s</button>
        </div>
      </div>

      <div class="card">
        <h3>クイック投入（履歴）</h3>
        <div class="row">
          <label for="tplExFromHist">種目</label>
          <select id="tplExFromHist">
            <option value="" selected disabled>（選択する）</option>
          </select>
        </div>
        <div class="row">
          <label for="tplPattern">パターン</label>
          <select id="tplPattern"></select>
        </div>
        <div class="row">
          <label class="check">
            <input id="tplUseLastW" type="checkbox" checked />
            前回重量を使う
          </label>
          <button id="btnTplApply" class="ghost" type="button">投入</button>
        </div>
        <small>パターンは履歴から自動生成（例：5×5, 3×8, 4×10）。重複はまとめて頻度順に並びます。</small>
      </div>

      <div class="card">
        <h3>カスタム投入</h3>
        <div class="grid grid-3">
          <input id="tplCustomSets"   inputmode="numeric"  placeholder="セット数（例 5）" autocomplete="off" />
          <input id="tplCustomReps"   inputmode="numeric"  placeholder="回数（例 5）"     autocomplete="off" />
          <input id="tplCustomWeight" inputmode="decimal"  placeholder="重量kg（例 40）"  autocomplete="off" />
        </div>

        <div class="row">
          <label>部位</label>
          <div id="tplPartChips" class="chipset" aria-label="部位(カスタム)">
            <button class="chip" data-part="胸" type="button">胸</button>
            <button class="chip" data-part="背中" type="button">背中</button>
            <button class="chip" data-part="肩" type="button">肩</button>
            <button class="chip" data-part="脚" type="button">脚</button>
            <button class="chip" data-part="腕" type="button">腕</button>
          </div>
        </div>
        <div class="row">
          <label for="tplExCustom">種目</label>
          <select id="tplExCustom">
            <option value="" selected disabled>（選択する）</option>
          </select>
          <button id="btnTplCustom" type="button">投入</button>
        </div>
      </div>

      <div class="card">
        <h3>今日のセット</h3>
        <ul id="todaySets" class="list"></ul>
        <div class="row end">
          <button id="btnUndo" class="ghost" type="button">一手戻す</button>
          <button id="btnSaveSession" type="button">セッション保存</button>
        </div>
      </div>
    </section>

    <!-- ===== 履歴 ===== -->
    <section id="tab-history" class="tab" role="tabpanel" aria-labelledby="tabbtn-history">
      <div class="card">
        <div class="row">
          <label for="historyCount">表示件数</label>
          <select id="historyCount">
            <option>10</option><option selected>20</option><option>50</option>
          </select>
          <button id="btnExport" class="ghost" type="button">CSV書き出し</button>
          <input type="file" id="importFile" accept=".csv" hidden />
          <label for="importFile" class="ghost btnlike">CSV読み込み</label>
        </div>
        <ul id="historyList" class="list"></ul>
      </div>
    </section>

    <!-- ===== 分析 ===== -->
    <section id="tab-analytics" class="tab" role="tabpanel" aria-labelledby="tabbtn-analytics">
      <!-- 追加：最新週サマリー -->
      <div class="card" id="weekly-summary" aria-live="polite">
        <h3>最新週サマリー</h3>
        <div id="weekly-summary-body">読み込み中…</div>
      </div>

      <div class="card">
        <h3>直近7日：合計ボリューム(kg)</h3>
        <canvas id="chart"></canvas>
        <div id="legend" class="legend"></div>
      </div>

      <div class="card">
        <h3>e1RM 推移</h3>
        <div class="row">
          <label for="exTrendSelect">種目</label>
          <select id="exTrendSelect" aria-label="ウォッチ種目から選択" aria-describedby="trendHint">
            <option value="" selected disabled>（選択する）</option>
          </select>
          <select id="trendRange" aria-label="表示範囲">
            <option value="10" selected>最近10回</option>
            <option value="20">最近20回</option>
            <option value="all">全期間</option>
          </select>
        </div>
        <canvas id="trendChart"></canvas>
        <div id="trendInfo" class="legend"></div>
        <small id="trendHint" style="display:block;margin-top:6px;color:var(--muted);"></small>
      </div>
    </section>

    <!-- ===== 設定 ===== -->
    <section id="tab-settings" class="tab" role="tabpanel" aria-labelledby="tabbtn-settings">
      <div class="card">
        <h3>種目管理</h3>
        <div class="row">
          <label for="filterPart">表示する部位</label>
          <select id="filterPart">
            <option value="all" selected>すべて</option>
            <option value="胸">胸</option><option value="背中">背中</option>
            <option value="肩">肩</option><option value="脚">脚</option><option value="腕">腕</option>
          </select>
        </div>
        <div class="grid grid-2">
          <input id="newExName" placeholder="例：ベンチプレス" autocomplete="off" />
          <select id="newExPart" aria-label="部位">
            <option value="">部位</option>
            <option value="胸">胸</option><option value="背中">背中</option>
            <option value="肩">肩</option><option value="脚">脚</option><option value="腕">腕</option>
          </select>
        </div>
        <div class="row"><button id="btnCreateEx" type="button">追加</button></div>
        <ul id="exList" class="list"></ul>
      </div>

      <!-- ウォッチ種目 -->
      <div class="card">
        <h3>ウォッチ種目（分析の e1RM で選択）</h3>
        <div class="row">
          <label>部位</label>
          <div id="watchPartChips" class="chipset" aria-label="ウォッチする部位">
            <button class="chip" data-part="胸"   type="button">胸</button>
            <button class="chip" data-part="背中" type="button">背中</button>
            <button class="chip" data-part="肩"   type="button">肩</button>
            <button class="chip" data-part="脚"   type="button">脚</button>
            <button class="chip" data-part="腕"   type="button">腕</button>
          </div>
        </div>

        <div class="row">
          <label for="watchExSelect">追加</label>
          <select id="watchExSelect">
            <option value="" selected disabled>（選択する）</option>
          </select>
          <button id="btnWatchAdd" type="button">追加</button>
        </div>

        <ul id="watchList" class="list"></ul>
        <small>ここで選んだ種目が、分析タブの「e1RM推移」で選択できます。</small>
      </div>

      <!-- 追加：タイマー設定 -->
      <div class="card">
        <h3>タイマー</h3>
        <div class="row">
          <label for="timerSec">既定秒数</label>
          <select id="timerSec">
            <option value="30">30秒</option>
            <option value="60" selected>60秒</option>
            <option value="90">90秒</option>
            <option value="120">120秒</option>
          </select>
          <label class="check">
            <input id="autoTimer" type="checkbox" />
            セット追加後に自動開始
          </label>
        </div>
      </div>

      <div class="card">
        <h3>通知 / データ</h3>
        <div class="row">
          <button id="btnNotif" class="ghost" type="button">通知を許可（休憩タイマー用）</button>
          <button id="btnWipe" class="danger" type="button">全データ削除</button>
        </div>
        <small>※ OSの通知設定でオフにしている場合は通知は表示されません。</small>
      </div>

      <div class="card">
        <h3>表示</h3>
        <label class="switch">
          <input id="darkToggle" type="checkbox" />
          <span>ダークモード</span>
        </label>
      </div>

      <!-- バックアップ -->
      <div class="card">
        <h3>バックアップ</h3>
        <div class="row">
          <button id="btnExportJson" class="ghost" type="button">JSON書き出し</button>
          <label for="jsonIn" class="ghost btnlike">JSON読み込み</label>
          <input id="jsonIn" type="file" accept="application/json" hidden />
        </div>
        <small>書き出しは端末に保存、読み込みはファイル選択で復元できます。</small>
      </div>

      <!-- ★ サポート（バックアップの後に配置） -->
      <div class="card">
        <h3>サポート</h3>
        <a class="btnlike ghost" href="support.html" rel="noopener">支援ページへ</a>
        <small>広告・紹介リンクからのご支援は開発継続に充てられます。</small>
      </div>

      <div class="card">
        <h3>情報</h3>
        <div class="kv">
          <div>バージョン</div><div>1.4.3</div>
          <div>プライバシー</div><div><a target="_blank" href="privacy.html" rel="noopener">プライバシーポリシー</a></div>
          <div>サポート</div>
          <div>
            <a href="mailto:toreninguguanli53@gmail.com?subject=Train%20Punch%20サポート"
               style="overflow-wrap:anywhere; word-break:break-word;">
              toreninguguanli53@gmail.com
            </a>
          </div>
        </div>
        <small>当アプリはトレーニング記録を目的としたツールです。医療情報や効果を保証するものではありません。安全に配慮し、体調に異変があれば医療機関に相談してください。</small>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script src="app.js?v=1.4.3" defer></script>
  <script src="sw-register.js" defer></script>

  <!-- 追加JS：最新週サマリー & ハードリロード -->
  <script type="module">
  // ====== 最新週サマリー ======
  const STORAGE_CANDIDATES = ['tp_sessions','tp_logs','sessions'];
  function loadEntries(){
    for(const k of STORAGE_CANDIDATES){
      try{ const raw = localStorage.getItem(k);
           if(!raw) continue;
           const arr = JSON.parse(raw);
           if(Array.isArray(arr) && arr.length) return arr;
      }catch{}
    }
    return [];
  }
  function toDate(x){
    if(x instanceof Date) return x;
    if(typeof x==='string'){
      const t = x.trim();
      const norm = t.includes('/') ? t : t.replaceAll('.','-').replaceAll('/','-');
      return new Date(norm);
    }
    return new Date(x||Date.now());
  }
  function isoWeekKey(d){
    const x = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const day = x.getUTCDay() || 7;
    x.setUTCDate(x.getUTCDate() + 4 - day);
    const yearStart = new Date(Date.UTC(x.getUTCFullYear(),0,1));
    const week = Math.ceil((((x - yearStart)/86400000)+1)/7);
    return `${x.getUTCFullYear()}-W${String(week).padStart(2,'0')}`;
  }
  const vol = e => typeof e.volume==='number' ? e.volume :
                      Number(e.weight||0) * Number(e.reps||0) * Number(e.sets||1);
  const fat = e => (typeof e.fatigue==='number' ? e.fatigue :
                    (typeof e.rpe==='number' ? e.rpe : null));

  function renderWeekly(){
    const el = document.getElementById('weekly-summary-body');
    if(!el) return;
    const data = loadEntries();
    if(!data.length){ el.textContent = '記録が見つかりません。入力するとここに今週の要約が出ます。'; return; }

    // group by ISO week
    const map = new Map();
    for(const e of data){
      const k = isoWeekKey(toDate(e.date));
      (map.get(k) || map.set(k,[]).get(k)).push(e);
    }
    const latestKey = [...map.keys()].sort().pop();
    const arr = map.get(latestKey);

    const totalVol = arr.reduce((s,e)=>s+vol(e),0);
    const fats = arr.map(fat).filter(v=>typeof v==='number');
    const avgFat = fats.length ? (fats.reduce((a,b)=>a+b,0)/fats.length) : null;

    // ★ しきい値はここを編集（=IF(B2<=1000,2, <=2000,4, <=3000,6, <=4000,8, 10)）
    let score = 10;
    if (totalVol <= 1000) score = 2;
    else if (totalVol <= 2000) score = 4;
    else if (totalVol <= 3000) score = 6;
    else if (totalVol <= 4000) score = 8;

    const comment =
      score <= 3 ? '基礎づくり週。次週は+10〜20%を目安に。' :
      score <= 6 ? '標準負荷。フォームと睡眠を重視。' :
      score <= 8 ? 'やや高負荷。補助種目を整理して回復時間を。' :
                   '高負荷。48–72hの回復と栄養を最優先。';

    el.innerHTML = `
      <div style="display:flex;gap:1rem;align-items:baseline;flex-wrap:wrap">
        <strong>対象週：</strong><span>${latestKey}</span>
        <strong>合計ボリューム：</strong><span>${Math.round(totalVol)}</span>
        <strong>強度スコア：</strong><span style="font-size:1.25rem">${score}/10</span>
        ${avgFat!=null ? `<strong>平均疲労度：</strong><span>${avgFat.toFixed(1)}</span>` : ''}
      </div>
      <p style="margin-top:.5rem">${comment}</p>
    `;
  }
  renderWeekly();

  // ====== ハードリロード（SW + Cache を全クリア） ======
  document.getElementById('btnHardRefresh')?.addEventListener('click', async () => {
    try {
      // Cache Storage削除
      if ('caches' in window) {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n)));
      }
      // Service Worker更新 & 待機中をスキップ
      if (navigator.serviceWorker?.controller) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.update()));
      }
    } catch(e) {
      console.warn('hard refresh failed', e);
    } finally {
      location.reload();
    }
  });
  </script>
</body>
</html>