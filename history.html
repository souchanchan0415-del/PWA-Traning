<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | アーカイブ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- カレンダー用の簡易スタイル（このページ専用） -->
  <style>
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: center;     /* 中央寄せ */
      margin-bottom: 8px;
      gap: 8px;
    }
    .calendar-month-label {
      font-size: 0.9rem;
      color: #f5f5f5;
      white-space: nowrap;         /* 折り返さない */
    }
    .calendar-nav-btn {
      display: inline-flex;        /* コンテンツサイズに合わせる */
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      border: 1px solid #2a2e3b;
      background: #181b24;
      color: #f5f5f5;
      padding: 2px 8px;            /* ボタンを小さく */
      font-size: 0.75rem;          /* 文字も小さく */
      cursor: pointer;
      flex: 0 0 auto;              /* flex でも伸びないようにする */
      width: auto;                 /* グローバルの width:100% を打ち消す */
      min-width: 0;
      line-height: 1.2;
    }
    .calendar-nav-btn:active {
      transform: scale(0.97);
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-top: 4px;
    }
    .calendar-cell-header {
      text-align: center;
      font-size: 0.75rem;
      color: #a0a3b1;
      padding: 2px 0 4px;
    }
    .calendar-day {
      position: relative;
      min-height: 40px;
      border-radius: 10px;
      padding: 4px 6px;
      font-size: 0.8rem;
      color: #f5f5f5;
      border: 1px solid transparent;
      background: #12141c;
      cursor: pointer;
      text-align: left;
    }
    .calendar-day.empty {
      cursor: default;
      background: transparent;
      border: none;
    }
    .calendar-day-number {
      font-size: 0.85rem;
    }
    .calendar-day.has-logs {
      border-color: #2a7fff;
      background: #151929;
    }
    .calendar-day.has-logs::after {
      content: "";
      position: absolute;
      right: 6px;
      bottom: 4px;
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #4f8cff;
    }
    .calendar-day.today {
      border-color: #f4c542;
    }
    .calendar-day.selected {
      border-color: #4f8cff;
      box-shadow: 0 0 0 1px rgba(79,140,255,0.4);
    }
    .calendar-legend {
      font-size: 0.75rem;
      color: #a0a3b1;
      margin-top: 4px;
    }
    .calendar-legend span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-right: 10px;
    }
    .calendar-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #4f8cff;
      display: inline-block;
    }
    .calendar-today-indicator {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid #f4c542;
      display: inline-block;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab">パフォーマンス</a>
      <a href="./history.html" class="tab active">アーカイブ</a>
      <a href="./settings.html" class="tab">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- カレンダー -->
    <section class="card">
      <div class="card-header-row">
        <h2 class="card-title">アーカイブ（カレンダー）</h2>
      </div>

      <p style="font-size:0.9rem; color:#c2c5d3; margin-bottom:12px;">
        月ごとのカレンダーから日付をタップすると、その日のワークアウトが下に表示されます。
      </p>

      <div class="calendar-header">
        <button type="button" id="prevMonthBtn" class="calendar-nav-btn">◀︎</button>
        <div class="calendar-month-label" id="monthLabel"></div>
        <button type="button" id="nextMonthBtn" class="calendar-nav-btn">▶︎</button>
      </div>

      <div class="calendar-grid" id="calendarGrid">
        <!-- JS で曜日と日付セルを生成 -->
      </div>

      <div class="calendar-legend">
        <span><span class="calendar-dot"></span> ログあり</span>
        <span><span class="calendar-today-indicator"></span> 今日</span>
      </div>
    </section>

    <!-- 選択した日の記録 -->
    <section class="card">
      <div class="card-header-row">
        <h2 class="card-title">選択した日の記録</h2>
        <span id="selectedDateLabel" style="margin-left:auto; font-size:0.85rem; color:#c2c5d3;"></span>
      </div>

      <div id="dayEmpty" class="empty">この日の記録はありません</div>

      <div class="table-wrapper">
        <table class="log-table" id="dayLogTable">
          <thead>
            <tr>
              <th>種目</th>
              <th>重量</th>
              <th>セット</th>
              <th>回数</th>
              <th>RPE</th>
              <th>メモ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="dayLogBody"></tbody>
        </table>
      </div>
    </section>

    <!-- 編集用カード -->
    <section class="card" id="editCard" style="display:none;">
      <h2 class="card-title">記録の編集</h2>
      <form id="editForm" class="form">
        <div class="field">
          <label for="editDate">日付</label>
          <input type="date" id="editDate" required>
        </div>

        <div class="field">
          <label for="editExercise">種目名</label>
          <input type="text" id="editExercise" required>
        </div>

        <div class="field-group">
          <div class="field">
            <label for="editWeight">重量(kg)</label>
            <input type="number" id="editWeight" step="0.5" inputmode="decimal">
          </div>
          <div class="field">
            <label for="editSets">セット数</label>
            <input type="number" id="editSets" inputmode="numeric" min="1">
          </div>
          <div class="field">
            <label for="editReps">回数</label>
            <input type="number" id="editReps" inputmode="numeric">
          </div>
        </div>

        <div class="field">
          <label for="editRpe">RPE</label>
          <input type="number" id="editRpe" step="0.5" inputmode="decimal">
        </div>

        <div class="field">
          <label for="editMemo">メモ</label>
          <textarea id="editMemo" rows="2"></textarea>
        </div>

        <div class="field-group">
          <button type="submit" class="btn-primary" style="flex:1;">保存する</button>
          <button type="button" id="cancelEditBtn" class="btn-secondary" style="flex:1; margin-left:8px;">
            キャンセル
          </button>
        </div>
      </form>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- ▼ 表示名 → ヘッダー反映用スクリプト ▼ -->
  <script>
    function getDisplayName() {
      return localStorage.getItem('trainPunchDisplayName') || '';
    }

    function applyDisplayNameToHeader() {
      const headerSub = document.querySelector('.header-sub');
      if (!headerSub) return;

      const name = getDisplayName();
      if (name) {
        headerSub.textContent =
          `トレーニング記録アプリ / ${name}のログ / ローカル保存版 v0.1`;
      } else {
        headerSub.textContent = 'トレーニング記録アプリ / ローカル保存版 v0.1';
      }
    }

    document.addEventListener('DOMContentLoaded', applyDisplayNameToHeader);
  </script>
  <!-- ▲ 表示名 → ヘッダー反映用スクリプト ▲ -->

  <script>
    // ---- ログ読み込み / 保存 --------------------------------------------

    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      } catch (_) {
        return null;
      }
    }

    function loadLogs() {
      const candidates = ['trainPunchLogs', 'train-punch-logs', 'TRAIN_PUNCH_LOGS'];
      for (const key of candidates) {
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      return [];
    }

    function saveLogs(nextLogs) {
      localStorage.setItem('trainPunchLogs', JSON.stringify(nextLogs));
    }

    // ---- 日付ユーティリティ ---------------------------------------------

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function formatDateLabel(dateStr) {
      return dateStr || '';
    }

    // ---- 状態変数 -------------------------------------------------------

    let logs = loadLogs();            // 全ログ
    let logsByDate = {};              // { 'YYYY-MM-DD': [index, index, ...] }
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth();  // 0-11
    let selectedDate = formatDate(today); // 選択中の日付
    let editingIndex = null;              // 編集中の logs[] のインデックス

    function rebuildLogsByDate() {
      logsByDate = {};
      logs.forEach((log, index) => {
        if (!log.date) return;
        if (!logsByDate[log.date]) {
          logsByDate[log.date] = [];
        }
        logsByDate[log.date].push(index);
      });
    }

    // ---- カレンダー描画 -------------------------------------------------

    const weekdayLabels = ['日', '月', '火', '水', '木', '金', '土'];

    function renderCalendar() {
      const monthLabel = document.getElementById('monthLabel');
      const grid = document.getElementById('calendarGrid');
      if (!monthLabel || !grid) return;

      monthLabel.textContent = `${currentYear}年${currentMonth + 1}月`;

      grid.innerHTML = '';

      // 曜日ヘッダー
      weekdayLabels.forEach(label => {
        const div = document.createElement('div');
        div.className = 'calendar-cell-header';
        div.textContent = label;
        grid.appendChild(div);
      });

      const firstDay = new Date(currentYear, currentMonth, 1);
      const startWeekday = firstDay.getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

      // 1日までの空セル
      for (let i = 0; i < startWeekday; i++) {
        const div = document.createElement('div');
        div.className = 'calendar-day empty';
        grid.appendChild(div);
      }

      const todayStr = formatDate(today);

      // 日付セル
      for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentYear, currentMonth, day);
        const dateStr = formatDate(dateObj);

        const div = document.createElement('button');
        div.type = 'button';
        div.className = 'calendar-day';

        const numberSpan = document.createElement('div');
        numberSpan.className = 'calendar-day-number';
        numberSpan.textContent = String(day);
        div.appendChild(numberSpan);

        if (logsByDate[dateStr] && logsByDate[dateStr].length > 0) {
          div.classList.add('has-logs');
        }
        if (dateStr === todayStr) {
          div.classList.add('today');
        }
        if (dateStr === selectedDate) {
          div.classList.add('selected');
        }

        div.addEventListener('click', () => {
          selectedDate = dateStr;
          renderCalendar();
          renderDayLogs();
        });

        grid.appendChild(div);
      }
    }

    // ---- 選択した日のログ描画 --------------------------------------------

    function renderDayLogs() {
      const label = document.getElementById('selectedDateLabel');
      const emptyEl = document.getElementById('dayEmpty');
      const tbody = document.getElementById('dayLogBody');
      const table = document.getElementById('dayLogTable');
      if (!label || !emptyEl || !tbody || !table) return;

      label.textContent = formatDateLabel(selectedDate);

      tbody.innerHTML = '';

      const indexList = logsByDate[selectedDate] || [];
      if (!indexList.length) {
        emptyEl.style.display = 'block';
        table.style.display = 'none';
        return;
      }

      emptyEl.style.display = 'none';
      table.style.display = 'table';

      indexList.forEach(idx => {
        const log = logs[idx];
        const tr = document.createElement('tr');

        const weightStr =
          log.weight != null && log.weight !== '' ? `${log.weight}kg` : '-';
        const setsStr =
          log.sets != null && log.sets !== '' ? `${log.sets}セット` : '-';
        const repsStr =
          log.reps != null && log.reps !== '' ? `${log.reps}回` : '-';
        const rpeStr =
          log.rpe != null && log.rpe !== '' ? String(log.rpe) : '-';
        const memoStr = log.memo || '';

        tr.innerHTML = `
          <td>${log.exercise || '-'}</td>
          <td>${weightStr}</td>
          <td>${setsStr}</td>
          <td>${repsStr}</td>
          <td>${rpeStr}</td>
          <td>${memoStr}</td>
          <td></td>
        `;

        const actionTd = tr.lastElementChild;

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = '編集';
        editBtn.className = 'btn-secondary small';
        editBtn.style.marginRight = '4px';

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.textContent = '削除';
        deleteBtn.className = 'btn-danger small';

        editBtn.addEventListener('click', () => openEditForm(idx));
        deleteBtn.addEventListener('click', () => deleteLog(idx));

        actionTd.appendChild(editBtn);
        actionTd.appendChild(deleteBtn);

        tbody.appendChild(tr);
      });
    }

    // ---- 編集処理 -------------------------------------------------------

    function openEditForm(index) {
      const log = logs[index];
      if (!log) return;

      editingIndex = index;

      const card = document.getElementById('editCard');
      const editDate = document.getElementById('editDate');
      const editExercise = document.getElementById('editExercise');
      const editWeight = document.getElementById('editWeight');
      const editSets = document.getElementById('editSets');
      const editReps = document.getElementById('editReps');
      const editRpe = document.getElementById('editRpe');
      const editMemo = document.getElementById('editMemo');

      editDate.value = log.date || '';
      editExercise.value = log.exercise || '';
      editWeight.value = log.weight != null ? log.weight : '';
      editSets.value = log.sets != null ? log.sets : '';
      editReps.value = log.reps != null ? log.reps : '';
      editRpe.value = log.rpe != null ? log.rpe : '';
      editMemo.value = log.memo || '';

      card.style.display = 'block';
      window.scrollTo({ top: card.offsetTop - 60, behavior: 'smooth' });
    }

    function closeEditForm() {
      const card = document.getElementById('editCard');
      if (card) card.style.display = 'none';
      editingIndex = null;
    }

    function deleteLog(index) {
      const log = logs[index];
      const dateLabel = log && log.date ? `（${log.date} / ${log.exercise || ''}）` : '';
      const ok = confirm(`この記録${dateLabel}を削除しますか？`);
      if (!ok) return;

      logs.splice(index, 1);
      saveLogs(logs);
      rebuildLogsByDate();

      renderCalendar();
      renderDayLogs();
    }

    // ---- 初期化 ---------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
      rebuildLogsByDate();

      const prevBtn = document.getElementById('prevMonthBtn');
      const nextBtn = document.getElementById('nextMonthBtn');

      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          selectedDate = formatDate(new Date(currentYear, currentMonth, 1));
          renderCalendar();
          renderDayLogs();
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          selectedDate = formatDate(new Date(currentYear, currentMonth, 1));
          renderCalendar();
          renderDayLogs();
        });
      }

      const editForm = document.getElementById('editForm');
      const cancelEditBtn = document.getElementById('cancelEditBtn');

      if (editForm) {
        editForm.addEventListener('submit', (e) => {
          e.preventDefault();
          if (editingIndex == null) return;

          const editDate = document.getElementById('editDate');
          const editExercise = document.getElementById('editExercise');
          const editWeight = document.getElementById('editWeight');
          const editSets = document.getElementById('editSets');
          const editReps = document.getElementById('editReps');
          const editRpe = document.getElementById('editRpe');
          const editMemo = document.getElementById('editMemo');

          const newDate = (editDate.value || '').trim();
          const newExercise = (editExercise.value || '').trim();
          if (!newDate || !newExercise) {
            alert('日付と種目名は必須です。');
            return;
          }

          const target = logs[editingIndex] || {};
          target.date = newDate;
          target.exercise = newExercise;
          target.weight = editWeight.value !== '' ? Number(editWeight.value) : '';
          target.sets = editSets.value !== '' ? Number(editSets.value) : '';
          target.reps = editReps.value !== '' ? Number(editReps.value) : '';
          target.rpe = editRpe.value !== '' ? Number(editRpe.value) : '';
          target.memo = editMemo.value || '';

          logs[editingIndex] = target;

          saveLogs(logs);
          rebuildLogsByDate();

          selectedDate = newDate;
          closeEditForm();
          renderCalendar();
          renderDayLogs();
        });
      }

      if (cancelEditBtn) {
        cancelEditBtn.addEventListener('click', () => {
          closeEditForm();
        });
      }

      // 初回描画
      renderCalendar();
      renderDayLogs();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>