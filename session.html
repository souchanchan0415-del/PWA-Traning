<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | ワークアウト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <!-- タブナビ（上部） -->
    <nav class="tab-nav">
      <a href="./session.html" class="tab active">ワークアウト</a>
      <a href="./analysis.html" class="tab">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab">システム</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2 class="card-title">記録入力</h2>
      <form id="logForm" class="form">
        <div class="field">
          <label for="date">日付</label>
          <input type="date" id="date" required>
        </div>

        <!-- ▼ 部位タブ＋種目一覧（折りたたみ） ▼ -->
        <div class="field">
          <label>部位と種目</label>

          <!-- 部位タブ（フォーム内） -->
          <div class="bodypart-tabs">
            <button type="button" class="bodypart-tab" data-part="chest">胸</button>
            <button type="button" class="bodypart-tab" data-part="back">背中</button>
            <button type="button" class="bodypart-tab" data-part="shoulder">肩</button>
            <button type="button" class="bodypart-tab" data-part="leg">脚</button>
            <button type="button" class="bodypart-tab" data-part="arm">腕</button>
            <button type="button" class="bodypart-tab" data-part="other">その他</button>
          </div>

          <!-- 種目リスト（部位タブを押すと開く） -->
          <div id="exerciseList" class="exercise-list"></div>

          <p class="selected-exercise-label">
            選択中の種目：<span id="selectedExerciseLabel">未選択</span>
          </p>

          <!-- 実際に保存に使う入力（画面上は非表示、必須） -->
          <input
            id="exercise"
            name="exercise"
            type="text"
            required
            style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0;"
            aria-hidden="true"
          >
        </div>
        <!-- ▲ 部位タブ＋種目一覧 ここまで ▲ -->

        <!-- 重量・セット数・回数 -->
        <div class="field-group">
          <div class="field">
            <label for="weight">重量(kg)</label>
            <input type="number" id="weight" step="0.5" inputmode="decimal" required>
          </div>
          <div class="field">
            <label for="sets">セット数</label>
            <input type="number" id="sets" inputmode="numeric" min="1">
          </div>
          <div class="field">
            <label for="reps">回数</label>
            <input type="number" id="reps" inputmode="numeric" required>
          </div>
        </div>

        <!-- RPE は一段下にまとめて配置 -->
        <div class="field">
          <div class="label-row">
            <label for="rpe">RPE</label>
            <button type="button" class="help-chip" id="rpeHelpToggle">?</button>
          </div>
          <input type="number" id="rpe" step="0.5" inputmode="decimal" placeholder="7.5">
          <p class="help-text" id="rpeHelp">
            0〜10でトレーニングの強度を表す指標です。<br>
            0 = まったくきつくない / 10 = もう1回は無理なくらい限界。
          </p>
        </div>

        <div class="field">
          <label for="memo">メモ</label>
          <textarea id="memo" rows="2" placeholder="セットの感覚など自由に"></textarea>
        </div>

        <button type="submit" class="btn-primary">保存する</button>
        <p id="message" class="message"></p>
      </form>
    </section>

    <section class="card">
      <div class="card-header-row">
        <h2 class="card-title">記録一覧</h2>
        <button id="clearAll" class="btn-danger small">全部削除</button>
      </div>
      <div id="emptyState" class="empty">まだ記録がありません</div>
      <div class="table-wrapper">
        <table class="log-table" id="logTable">
          <thead>
            <tr>
              <th>日付</th>
              <th>種目</th>
              <th>重量</th>
              <th>セット</th>
              <th>回数</th>
              <th>RPE</th>
              <th>メモ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logBody">
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- ▼ 表示名 → ヘッダー反映用スクリプト ▼ -->
  <script>
    function getDisplayName() {
      return localStorage.getItem('trainPunchDisplayName') || '';
    }

    function applyDisplayNameToHeader() {
      const headerSub = document.querySelector('.header-sub');
      if (!headerSub) return;

      const name = getDisplayName();
      if (name) {
        headerSub.textContent = `トレーニング記録アプリ / ${name}のログ / ローカル保存版 v0.1`;
      } else {
        headerSub.textContent = 'トレーニング記録アプリ / ローカル保存版 v0.1';
      }
    }

    document.addEventListener('DOMContentLoaded', applyDisplayNameToHeader);
  </script>
  <!-- ▲ 表示名 → ヘッダー反映用スクリプト ▲ -->

  <script src="./app.js"></script>

  <!-- 部位タブ＆種目リスト＋RPEヘルプの制御用スクリプト -->
  <script>
    // カスタム種目保存で使っているキー（settings.html と共通）
    const CUSTOM_EXERCISES_KEY = 'trainPunchCustomExercises';

    function loadCustomExercises() {
      const raw = localStorage.getItem(CUSTOM_EXERCISES_KEY);
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch (_) {
        return {};
      }
    }

    // デフォルトの部位ごとの種目一覧
    const EXERCISE_GROUPS = {
      chest: [
        'ベンチプレス',
        '足上げベンチ',
        'スミスマシンベンチプレス',
        'インクラインダンベルプレス',
        'インクラインマシンプレス',
        'ディップス',
        'ディップス(荷重)',
        'ケーブルクロスオーバー',
        'ペックフライ',
        'チェストプレス',
        'スミス インクラインプレス',
        'スミス デクラインプレス'
      ],
      back: [
        'デットリフト',
        'ハーフデットリフト',
        'デッドリフト',
        'ハーフデッドリフト',
        'チンニング',
        '懸垂',
        'ラットプルダウン',
        'ラットプルダウン（ナロー）',
        'ラットプルダウン（ちょーナロー）',
        'ワイドラットプルダウン',
        'スミスマシンベントオーバーロウ',
        'ベントオーバーロウ',
        'ローロウ',
        'シーテッドロウ',
        'Tバーロウ',
        'Tバーロー'
      ],
      shoulder: [
        'ダンベルショルダープレス',
        'スミスマシンショルダープレス',
        'スミスショルダープレス',
        'マシンショルダープレス',
        'ケーブルフロントレイズ',
        'サイドレイズ',
        'ベンチサイドレイズ',
        'ケーブルサイドレイズ',
        'ケーブルリアレイズ',
        'リアデルトイド'
      ],
      leg: [
        'スクワット',
        'バーベルスクワット',
        'レッグプレス',
        'バックスクワット',
        'レッグカール',
        'レッグエクステンション',
        'インナーサイ',
        'ルーマニアンデットリフト',
        'スティフレッグデッドリフト'
      ],
      arm: [
        'バーベルカール',
        'インクラインダンベルカール',
        'ハンマーカール',
        'ダンベルプリチャーカール(右/左)',
        'インクラインダンベルカール(右/左)',
        'スミスマシンナロープレス',
        'ナロープレス',
        'スカルクラッシャー',
        'フレンチプレス',
        'ケーブルプレスダウン',
        'スミスJMプレス',
        '[三頭]ケーブルプレスダウン'
      ],
      other: [
        'その他'
      ]
    };

    // settings.html で登録したカスタム種目を既存グループにマージ
    function mergeCustomExercisesIntoGroups() {
      const map = loadCustomExercises();
      Object.keys(map).forEach(partKey => {
        const list = Array.isArray(map[partKey]) ? map[partKey] : [];
        if (!EXERCISE_GROUPS[partKey]) {
          EXERCISE_GROUPS[partKey] = [];
        }
        const baseList = EXERCISE_GROUPS[partKey];
        list.forEach(name => {
          if (!baseList.includes(name)) {
            baseList.push(name);
          }
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // まずカスタム種目をマージ
      mergeCustomExercisesIntoGroups();

      const bodypartTabs = document.querySelectorAll('.bodypart-tab');
      const exerciseList = document.getElementById('exerciseList');
      const exerciseInput = document.getElementById('exercise');
      const selectedLabel = document.getElementById('selectedExerciseLabel');

      if (!bodypartTabs.length || !exerciseList || !exerciseInput || !selectedLabel) return;

      let openPart = null; // どの部位が「開いているか」

      function clearSelection() {
        exerciseList.innerHTML = '';
        exerciseList.style.display = 'none';
        exerciseInput.value = '';
        selectedLabel.textContent = '未選択';
      }

      function renderExercises(partKey) {
        exerciseList.innerHTML = '';
        const list = EXERCISE_GROUPS[partKey] || [];

        list.forEach(name => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'exercise-chip';
          btn.textContent = name;

          btn.addEventListener('click', () => {
            // クリックされた種目だけ残して他は非表示
            exerciseList.querySelectorAll('.exercise-chip').forEach(b => {
              if (b === btn) {
                b.classList.add('active');
                b.classList.remove('hidden');
              } else {
                b.classList.remove('active');
                b.classList.add('hidden'); // 非選択の種目を隠す
              }
            });

            exerciseInput.value = name;
            selectedLabel.textContent = name;
          });

          exerciseList.appendChild(btn);
        });

        exerciseList.style.display = 'block';
        exerciseInput.value = '';
        selectedLabel.textContent = '未選択';
      }

      bodypartTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const partKey = tab.dataset.part;

          // 同じ部位をもう一度タップ → 閉じる＆リセット
          if (openPart === partKey) {
            openPart = null;
            bodypartTabs.forEach(t => t.classList.remove('active'));
            clearSelection();
            return;
          }

          // 別の部位をタップ → そっちを開く（一覧を再生成して全種目表示）
          openPart = partKey;
          bodypartTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          renderExercises(partKey);
        });
      });

      // 初期状態は全部閉じる
      clearSelection();

      // ---- RPE ヘルプの開閉 ----
      const rpeHelpToggle = document.getElementById('rpeHelpToggle');
      const rpeHelp = document.getElementById('rpeHelp');
      if (rpeHelpToggle && rpeHelp) {
        rpeHelpToggle.addEventListener('click', () => {
          rpeHelp.classList.toggle('show');
        });
      }
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>