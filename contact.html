<!doctype html>
<html lang="ja">
<head>
  <!-- Train Punch – Contact / v1.5.9-safari-fix -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>お問い合わせ | Train Punch</title>
  <meta name="description" content="Train Punch（トレインパンチ）へのお問い合わせページ。バグ報告、改善提案、その他のご連絡はこちらから。">
  <meta name="theme-color" content="#0fb6a9">

  <!-- PWA / Icons -->
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./icons/icon-180.png">

  <!-- OGP（絶対URL） -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="お問い合わせ | Train Punch">
  <meta property="og:description" content="Train Punchへのお問い合わせ。バグ報告や機能要望はこちら。">
  <meta property="og:url" content="https://trainpunch.github.io/PWA-Traning/contact.html">
  <meta property="og:image" content="https://trainpunch.github.io/PWA-Traning/icons/icon-512.png">

  <!-- 統一CSS -->
  <link rel="stylesheet" href="./styles.css?v=1.5.5-hotfix1">

  <style>
    :root{--bg:#f7fafc;--card:#fff;--text:#1a202c;--muted:#6b7280;--line:#e5e7eb;--brand:#0fb6a9;--brand-weak:#6cc7bf;--danger:#e11d48;--focus:#0fb6a940;--shadow:0 2px 22px rgba(0,0,0,.06)}
    @media (prefers-color-scheme: dark){:root{--bg:#0b0f14;--card:#10151c;--text:#e5e7eb;--muted:#a1a1aa;--line:#1f2937;--shadow:0 2px 22px rgba(0,0,0,.35)}}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP","Meiryo",sans-serif;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent}

    /* ページ固有の最小レイアウト（機能追加なし） */
    .wrap{max-width:860px;margin:0 auto;padding:16px}
    main{padding:24px 0 40px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:18px;margin-bottom:16px}
    h1{font-size:20px;margin:6px 0 14px} h2{font-size:16px;margin:0 0 10px} p{margin:0 0 10px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr;gap:14px} @media(min-width:720px){.row{grid-template-columns:1fr 1fr}}
    label{display:block;font-weight:600;margin:6px 0}
    input[type="text"],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:transparent;color:var(--text);outline:none}
    textarea{min高さ:140px;min-height:140px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button,.btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px;touch-action:manipulation}
    button:focus-visible,.btn:focus-visible{outline:3px solid var(--focus)}
    .btn.secondary{background:var(--brand-weak);color:#0b1216}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    .btn.danger{background:var(--danger)}
    details{border:1px solid var(--line);border-radius:10px;padding:12px;background:transparent}
    summary{cursor:pointer;font-weight:700}

    /* 右上戻る：styles.css の .appbar を使いつつ保険で右寄せ */
    .appbar .iconbtn{margin-left:auto}
  </style>
</head>
<body>
  <!-- 右上に戻るボタンで統一 -->
  <header class="appbar" role="banner">
    <h1 class="logo">お問い合わせ</h1>
    <a class="iconbtn" href="./index.html" title="アプリへ戻る" aria-label="アプリへ戻る" role="button">←</a>
  </header>

  <main class="wrap">
    <h1>お問い合わせ</h1>
    <p class="muted">バグ報告・改善提案・データの移行相談など、こちらからどうぞ。メール作成補助も用意しています。</p>

    <section class="card" aria-labelledby="contact-ways">
      <h2 id="contact-ways">すぐに連絡する</h2>
      <p>下のボタンでメールアプリが開きます（件名にアプリ名とバージョンを自動付与）。</p>
      <div class="actions">
        <a id="mailtoQuick" class="btn" href="#" rel="noopener">メールを開く</a>
        <button id="copyMail" class="btn ghost" type="button">メールアドレスをコピー</button>
        <span class="copy" id="mailShown" aria-live="polite"></span>
      </div>
      <p class="hint">メールが開かない場合は、上のコピーからアドレスを貼り付けて送信してください。</p>
    </section>

    <section class="card" aria-labelledby="compose-helper">
      <h2 id="compose-helper">バグ報告 / ご要望（メール作成補助）</h2>
      <div class="row" role="group" aria-label="問い合わせ内容">
        <div>
          <label for="topic">種別</label>
          <select id="topic">
            <option>バグ報告</option>
            <option>改善提案</option>
            <option>データ復元・移行</option>
            <option>その他</option>
          </select>
        </div>
        <div>
          <label for="subject">件名</label>
          <input id="subject" type="text" placeholder="例）履歴が表示されない / チャートが崩れる など" inputmode="text" autocomplete="off" autocapitalize="off" spellcheck="false">
        </div>
      </div>

      <label for="message">本文</label>
      <textarea id="message" placeholder="再現手順：
1）…
2）…
期待した動作：
実際の動作：
スクリーンショット/動画の有無："></textarea>

      <label style="margin-top:8px"><input type="checkbox" id="includeEnv" checked> 環境情報（端末/ブラウザ/タイムゾーン等）を本文末尾に自動で付ける</label>
      <div class="actions">
        <button id="buildMail" class="btn" type="button">メールを作成</button>
        <button id="copyTemplate" class="btn secondary" type="button">本文テンプレをコピー</button>
      </div>
      <p class="hint">※サーバー送信は行いません。端末のメールアプリで送信します。</p>
    </section>

    <section class="card" aria-labelledby="faq">
      <h2 id="faq">よくある質問</h2>
      <details>
        <summary>アプリはオフラインで使えますか？</summary>
        <p>はい。Train Punch は PWA なので、初回読み込み後はオフラインでも利用できます。定期的に「更新」すると最新の不具合修正を反映できます。</p>
      </details>
      <details>
        <summary>データはどこに保存されていますか？</summary>
        <p>端末内の <strong>IndexedDB</strong> に保存されます。<span class="tag">設定 → JSONエクスポート</span> でバックアップ、<span class="tag">JSONインポート</span> で復元できます。</p>
      </details>
      <details>
        <summary>問い合わせの前に確認したいこと</summary>
        <ul>
          <li>アプリ右上の「↻更新」ボタン、もしくは設定の「ハードリフレッシュ」を試す</li>
          <li>キャッシュを削除して再読み込み</li>
          <li>最新のブラウザ/OS へアップデート</li>
        </ul>
      </details>
      <details>
        <summary>設定画面へ移動したい</summary>
        <p><a class="btn ghost" href="https://trainpunch.github.io/PWA-Traning/index.html#tab-settings">設定タブを開く</a></p>
      </details>
    </section>
  </main>

  <footer>
    <div class="wrap">
      <div>© <span id="year"></span> Train Punch</div>
      <div class="muted">v1.5.9-safari-fix • このページは通信を行わず、メール作成時のみ端末のメーラーを呼び出します。</div>
    </div>
  </footer>

  <script>
    const SUPPORT_EMAIL = 'toreninguguanli53@gmail.com';
    const APP_VERSION = 'v1.5.9-safari-fix';

    // 年表示
    document.getElementById('year').textContent = new Date().getFullYear();

    // 宛先表示＆既定mailto（件名のみ）
    const mailShown = document.getElementById('mailShown');
    mailShown.textContent = SUPPORT_EMAIL;
    const mailtoQuickHref =
      `mailto:${encodeURIComponent(SUPPORT_EMAIL)}?subject=${encodeURIComponent('【Train Punch】お問い合わせ ' + APP_VERSION)}`;
    const mailtoQuick = document.getElementById('mailtoQuick');
    mailtoQuick.setAttribute('href', mailtoQuickHref);

    // クリップボード共通
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast('コピーしました');
      }catch(_){
        const ta=document.createElement('textarea');
        ta.value=text; ta.setAttribute('readonly',''); ta.style.position='fixed'; ta.style.left='-9999px';
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        toast('コピーしました');
      }
    }
    document.getElementById('copyMail').addEventListener('click', ()=> copyText(SUPPORT_EMAIL));
    document.getElementById('copyTemplate').addEventListener('click', ()=>{
      const tpl=`再現手順：
1）…
2）…
期待した動作：
実際の動作：
スクリーンショット/動画の有無：`;
      copyText(tpl);
    });

    // === mailto フォールバック：UI追加なし、失敗時のみコピー＋案内 ===
    function openMailto(url, onFail){
      let done=false, tid;
      const ok = ()=>{ if(done) return; done=true; cleanup(); };
      const fail= ()=>{ if(done) return; done=true; cleanup(); onFail && onFail(); };
      function cleanup(){
        clearTimeout(tid);
        document.removeEventListener('visibilitychange', onVis, true);
        window.removeEventListener('pagehide', onHide, true);
        window.removeEventListener('blur', onBlur, true);
      }
      const onVis = ()=>{ if(document.hidden) ok(); };
      const onHide= ()=> ok();
      const onBlur= ()=> ok();

      document.addEventListener('visibilitychange', onVis, {once:true, capture:true});
      window.addEventListener('pagehide', onHide, {once:true, capture:true});
      window.addEventListener('blur', onBlur, {once:true, capture:true});

      // a.click() 方式（モバイルの相性が良い）
      const a=document.createElement('a');
      a.href=url; a.rel='noopener'; a.style.display='none';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{ try{ document.body.removeChild(a); }catch(_){} }, 800);

      // 1.6秒以内にフォーカス離脱/非表示が無ければ失敗と見なす
      tid=setTimeout(fail, 1600);
    }

    // 「メールを開く」：件名のみ
    mailtoQuick.addEventListener('click', (e)=>{
      e.preventDefault();
      openMailto(mailtoQuickHref, ()=>{
        copyText(SUPPORT_EMAIL);
        alert('メールアプリを開けませんでした。\n宛先をコピーしましたので、メールアプリで貼り付けて送信してください。\n\n宛先: ' + SUPPORT_EMAIL);
      });
    });

    // メール本文組み立て＋起動
    document.getElementById('buildMail').addEventListener('click', ()=>{
      const topic   = document.getElementById('topic').value.trim();
      const subject = (document.getElementById('subject').value.trim() || `${topic}について`);
      const msg     = document.getElementById('message').value.trim();
      const withEnv = document.getElementById('includeEnv').checked;
      const env     = withEnv ? buildEnvBlock() : '';
      const body    = `${msg}${msg?'\n\n':''}${env}`;

      const url = `mailto:${encodeURIComponent(SUPPORT_EMAIL)}?subject=${encodeURIComponent(`【Train Punch】${subject} ${APP_VERSION}`)}&body=${encodeURIComponent(body)}`;

      openMailto(url, ()=>{
        copyText(`${subject}\n\n${body}`);
        alert('メールアプリを開けませんでした。\n件名と本文をコピーしましたので、メールに貼り付けて送信してください。\n\n宛先: ' + SUPPORT_EMAIL);
      });
    });

    function buildEnvBlock(){
      const tz  = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      const lang= navigator.language || '';
      const ua  = navigator.userAgent || '';
      const plat= navigator.platform || '';
      const vw  = Math.max(document.documentElement.clientWidth, window.innerWidth||0);
      const vh  = Math.max(document.documentElement.clientHeight, window.innerHeight||0);
      const standalone = window.matchMedia('(display-mode: standalone)').matches;
      const now = new Date();
      return [
        '―――― 環境情報（自動追記）――――',
        `アプリ: Train Punch ${APP_VERSION}`,
        `日時: ${now.toLocaleString()}`,
        `タイムゾーン: ${tz}`,
        `言語: ${lang}`,
        `ブラウザUA: ${ua}`,
        `プラットフォーム: ${plat}`,
        `画面: ${vw}×${vh}`,
        `PWA(スタンドアロン): ${standalone?'はい':'いいえ'}`,
        '――――――――――――――――――――'
      ].join('\n');
    }

    // 既存のトースト（UI追加なし）
    function toast(msg){
      let t=document.getElementById('toast');
      if(!t){
        t=document.createElement('div'); t.id='toast';
        Object.assign(t.style,{position:'fixed',left:'50%',bottom:'28px',transform:'translateX(-50%)',background:'var(--text)',color:'var(--card)',padding:'10px 14px',borderRadius:'999px',zIndex:50,opacity:'0',transition:'opacity .18s ease, transform .18s ease',boxShadow:'var(--shadow)',fontWeight:'700',pointerEvents:'none'});
        document.body.appendChild(t);
      }
      t.textContent=msg; t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(-4px)';
      setTimeout(()=>{t.style.opacity='0'; t.style.transform='translateX(-50%)';},1400);
    }
  </script>

  <!-- SW を全ページ同一で読み込む（統一版） -->
  <script defer src="./sw-register.js?v=1.6.1-unify"></script>
</body>
</html>