<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | パフォーマンス</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab active">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- 直近7日分のボリューム -->
    <section class="card">
      <h2 class="card-title">週間ボリューム（kg）</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        直近7日分の、1日あたり合計ボリューム（重量×回数×セット数）の推移です。
      </p>
      <div style="margin-top:12px; height:260px;">
        <canvas id="weeklyVolumeChart"></canvas>
      </div>
    </section>

    <!-- 直近7日分の部位別割合（円グラフ） -->
    <section class="card">
      <h2 class="card-title">1週間 部位別ボリューム割合</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        直近7日分の合計ボリューム（重量×回数×セット数）を、<br>
        部位ごとの割合で表示します。
      </p>
      <p class="period-note">集計期間：直近7日</p>
      <div style="margin-top:12px; height:260px;">
        <canvas id="bodyPartPieChart"></canvas>
      </div>
    </section>

    <!-- 直近7日分の平均RPE -->
    <section class="card">
      <h2 class="card-title">1日平均 RPE</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        直近7日分の平均RPEの推移です。記録がある日のみ点が表示されます。
      </p>
      <div style="margin-top:12px; height:260px;">
        <canvas id="dailyRpeChart"></canvas>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ---- ログ読み込み ---------------------------------------------------

    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      } catch (_) {
        return null;
      }
    }

    function loadLogs() {
      const candidates = ['trainPunchLogs', 'train-punch-logs', 'TRAIN_PUNCH_LOGS'];
      for (const key of candidates) {
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      return [];
    }

    // ---- 日付ユーティリティ ---------------------------------------------

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function getLast7Days() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const days = [];
      for (let i = 6; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        days.push(formatDate(d));
      }
      return days; // 古い日付 → 今日 の順
    }

    const logs = loadLogs();
    const last7Days = getLast7Days();
    const last7DaySet = new Set(last7Days);

    // 表示用ラベル（YYYY-MM-DD → MM/DD）
    const shortLabels = last7Days.map(dateStr => {
      // "2025-11-27" → "11/27"
      return dateStr.substring(5).replace('-', '/');
    });

    // ---- 種目 → 部位 マッピング -----------------------------------------

    const EXERCISE_TO_PART = {
      // 胸
      'ベンチプレス': '胸',
      '足上げベンチ': '胸',
      'スミスマシンベンチプレス': '胸',
      'インクラインダンベルプレス': '胸',
      'インクラインマシンプレス': '胸',
      'ディップス': '胸',
      'ディップス(荷重)': '胸',
      'ケーブルクロスオーバー': '胸',
      'ペックフライ': '胸',
      'チェストプレス': '胸',
      'スミス インクラインプレス': '胸',
      'スミス デクラインプレス': '胸',

      // 背中
      'デットリフト': '背中',
      'ハーフデットリフト': '背中',
      'デッドリフト': '背中',
      'ハーフデッドリフト': '背中',
      'チンニング': '背中',
      '懸垂': '背中',
      'ラットプルダウン': '背中',
      'ラットプルダウン（ナロー）': '背中',
      'ラットプルダウン（ちょーナロー）': '背中',
      'ワイドラットプルダウン': '背中',
      'スミスマシンベントオーバーロウ': '背中',
      'ベントオーバーロウ': '背中',
      'ローロウ': '背中',
      'シーテッドロウ': '背中',
      'Tバーロウ': '背中',
      'Tバーロー': '背中',

      // 肩
      'ダンベルショルダープレス': '肩',
      'スミスマシンショルダープレス': '肩',
      'スミスショルダープレス': '肩',
      'マシンショルダープレス': '肩',
      'ケーブルフロントレイズ': '肩',
      'サイドレイズ': '肩',
      'ベンチサイドレイズ': '肩',
      'ケーブルサイドレイズ': '肩',
      'ケーブルリアレイズ': '肩',
      'リアデルトイド': '肩',

      // 脚
      'スクワット': '脚',
      'バーベルスクワット': '脚',
      'レッグプレス': '脚',
      'バックスクワット': '脚',
      'レッグカール': '脚',
      'レッグエクステンション': '脚',
      'インナーサイ': '脚',
      'ルーマニアンデットリフト': '脚',
      'スティフレッグデッドリフト': '脚',

      // 腕
      'バーベルカール': '腕',
      'インクラインダンベルカール': '腕',
      'ハンマーカール': '腕',
      'ダンベルプリチャーカール(右/左)': '腕',
      'インクラインダンベルカール(右/左)': '腕',
      'スミスマシンナロープレス': '腕',
      'ナロープレス': '腕',
      'スカルクラッシャー': '腕',
      'フレンチプレス': '腕',
      'ケーブルプレスダウン': '腕',
      'スミスJMプレス': '腕',
      '[三頭]ケーブルプレスダウン': '腕',

      // その他
      'その他': 'その他'
    };

    const BODY_PARTS = ['胸', '背中', '肩', '脚', '腕', 'その他'];

    // ---- 集計ロジック ---------------------------------------------------

    // 1日あたりの合計ボリューム（重量×回数×セット数）
    const dailyVolume = last7Days.map(dateStr => {
      let sum = 0;
      for (const log of logs) {
        if (log.date === dateStr) {
          const w = Number(log.weight);
          const r = Number(log.reps);
          // セット数が無い古いログは 1 セット扱い
          const s = log.sets != null && log.sets !== ''
            ? Number(log.sets)
            : 1;

          if (!Number.isNaN(w) && !Number.isNaN(r) && !Number.isNaN(s)) {
            sum += w * r * s;
          }
        }
      }
      return sum;
    });

    // 部位別ボリューム（直近7日分合計）
    const bodyPartVolume = {
      '胸': 0,
      '背中': 0,
      '肩': 0,
      '脚': 0,
      '腕': 0,
      'その他': 0
    };

    for (const log of logs) {
      if (!last7DaySet.has(log.date)) continue;

      const w = Number(log.weight);
      const r = Number(log.reps);
      const s = log.sets != null && log.sets !== ''
        ? Number(log.sets)
        : 1;

      if (Number.isNaN(w) || Number.isNaN(r) || Number.isNaN(s)) continue;

      const vol = w * r * s;
      const part = EXERCISE_TO_PART[log.exercise] || 'その他';
      if (!bodyPartVolume.hasOwnProperty(part)) {
        bodyPartVolume['その他'] += vol;
      } else {
        bodyPartVolume[part] += vol;
      }
    }

    const totalBodyPartVolume = BODY_PARTS.reduce(
      (sum, part) => sum + (bodyPartVolume[part] || 0),
      0
    );

    // 1日あたりの平均RPE
    const dailyAvgRpe = last7Days.map(dateStr => {
      let total = 0;
      let count = 0;
      for (const log of logs) {
        if (log.date === dateStr && log.rpe !== undefined && log.rpe !== null && log.rpe !== '') {
          const rpe = Number(log.rpe);
          if (!Number.isNaN(rpe)) {
            total += rpe;
            count++;
          }
        }
      }
      return count ? Number((total / count).toFixed(2)) : null;
    });

    // ---- 円グラフ中央テキスト用プラグイン ------------------------------
    // afterDatasetsDraw で中央テキストを描画し、
    // ツールチップが出ているフレームでは描画しない。
    const centerTextPlugin = {
      id: 'centerText',
      afterDatasetsDraw(chart, args, pluginOptions) {
        const tooltip = chart.tooltip;
        if (tooltip && tooltip.opacity > 0) {
          // ツールチップ表示中は中央テキストを描かない
          return;
        }

        const total = pluginOptions.total;
        if (!total || total <= 0) return;

        const { ctx, chartArea } = chart;
        if (!chartArea) return;

        const { left, right, top, bottom } = chartArea;
        const x = (left + right) / 2;
        const y = (top + bottom) / 2;

        ctx.save();
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#f5f5f5';

        ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, system-ui, sans-serif';
        ctx.fillText('合計ボリューム', x, y - 10);

        ctx.font = 'bold 15px -apple-system, BlinkMacSystemFont, system-ui, sans-serif';
        ctx.fillText(`${total.toLocaleString()}kg`, x, y + 12);

        ctx.restore();
      }
    };

    // ---- グラフ描画 -----------------------------------------------------

    function createWeeklyVolumeChart() {
      const ctx = document.getElementById('weeklyVolumeChart');
      if (!ctx) return;

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: shortLabels,
          datasets: [
            {
              label: '合計ボリューム (kg)',
              data: dailyVolume
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: {
                display: true,
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#c2c5d3',
                maxRotation: 0,
                autoSkip: false
              }
            },
            y: {
              beginAtZero: true,
              grid: {
                display: true,
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#c2c5d3'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#f5f5f5'
              }
            }
          }
        }
      });
    }

    function createBodyPartPieChart() {
      const ctx = document.getElementById('bodyPartPieChart');
      if (!ctx) return;

      const data = BODY_PARTS.map(part => bodyPartVolume[part] || 0);

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: BODY_PARTS,
          datasets: [
            {
              data,
              backgroundColor: [
                '#4f8cff', // 胸
                '#50c878', // 背中
                '#f4c542', // 肩
                '#ff6b6b', // 脚
                '#a56bff', // 腕
                '#8892b0'  // その他
              ]
            }
          ]
        },
        plugins: [centerTextPlugin],
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            centerText: {
              total: totalBodyPartVolume
            },
            legend: {
              labels: {
                color: '#f5f5f5'
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = totalBodyPartVolume || 0;
                  const percent = total > 0 ? (value / total) * 100 : 0;
                  const valueStr = value.toLocaleString();
                  const percentStr = percent.toFixed(1);
                  return `${label}: ${valueStr}kg (${percentStr}%)`;
                }
              }
            }
          }
        }
      });
    }

    function createDailyRpeChart() {
      const ctx = document.getElementById('dailyRpeChart');
      if (!ctx) return;

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: shortLabels,
          datasets: [
            {
              label: '平均RPE',
              data: dailyAvgRpe,
              spanGaps: false,
              pointRadius: 4,
              pointHitRadius: 6,
              tension: 0.25
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              grid: {
                display: true,
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#c2c5d3',
                maxRotation: 0,
                autoSkip: false
              }
            },
            y: {
              beginAtZero: true,
              suggestedMax: 10,
              grid: {
                display: true,
                color: 'rgba(255, 255, 255, 0.05)'
              },
              ticks: {
                color: '#c2c5d3'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: '#f5f5f5'
              }
            }
          }
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      createWeeklyVolumeChart();
      createBodyPartPieChart();
      createDailyRpeChart();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>