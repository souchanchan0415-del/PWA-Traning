<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | パフォーマンス</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab active">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- 週間ボリューム -->
    <section class="card">
      <h2 class="card-title">週間ボリューム推移</h2>
      <p style="font-size:0.8rem; color:#a0a3b1; margin-top:0; margin-bottom:8px;">
        「重量 × 回数」の合計を週ごとに集計したグラフです。
      </p>
      <div class="table-wrapper" style="max-height:260px;">
        <canvas id="weeklyVolumeChart"></canvas>
      </div>
      <p id="weeklyVolumeEmpty" class="empty" style="margin-top:8px; display:none;">
        まだ集計できる記録がありません。ワークアウトから記録を追加してください。
      </p>
    </section>

    <!-- 1日平均RPE -->
    <section class="card">
      <h2 class="card-title">1日平均 RPE 推移</h2>
      <p style="font-size:0.8rem; color:#a0a3b1; margin-top:0; margin-bottom:8px;">
        同じ日に記録されたセットのRPEの平均値です（未入力のセットは除外）。
      </p>
      <div class="table-wrapper" style="max-height:260px;">
        <canvas id="dailyRpeChart"></canvas>
      </div>
      <p id="dailyRpeEmpty" class="empty" style="margin-top:8px; display:none;">
        まだRPE付きの記録がありません。ワークアウトでRPEを入力すると推移が表示されます。
      </p>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- グラフ用ライブラリ（CDN版 Chart.js） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ここでも SW を登録してOK（session.html と同じ）
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }

    // ★ ログの保存キー（app.js の実装に合わせて必要なら変更）
    const STORAGE_KEY = 'train-punch-logs';

    function loadLogs() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const data = JSON.parse(raw);
        if (!Array.isArray(data)) return [];
        return data;
      } catch (e) {
        console.error('ログ読込エラー', e);
        return [];
      }
    }

    function toDateOnlyString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getWeekStart(date) {
      // 月曜始まりの週の開始日
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = d.getDay(); // 0:日〜6:土
      const diff = (day + 6) % 7; // 月曜を0に
      d.setDate(d.getDate() - diff);
      return d;
    }

    // 週間ボリューム（重量×回数の合計）を週ごとに集計
    function buildWeeklyVolume(logs) {
      const weeklyMap = new Map();

      logs.forEach((log) => {
        const { date, weight, reps } = log;
        if (!date) return;

        const w = Number(weight);
        const r = Number(reps);
        if (!isFinite(w) || !isFinite(r)) return;

        const d = new Date(date);
        if (isNaN(d.getTime())) return;

        const weekStart = getWeekStart(d);
        const key = toDateOnlyString(weekStart);
        const volume = w * r;

        weeklyMap.set(key, (weeklyMap.get(key) || 0) + volume);
      });

      const labels = Array.from(weeklyMap.keys()).sort();
      const data = labels.map((k) => weeklyMap.get(k));

      return { labels, data };
    }

    // 日別の平均RPEを集計
    function buildDailyAverageRpe(logs) {
      const rpeMap = new Map(); // date -> { sum, count }

      logs.forEach((log) => {
        const { date, rpe } = log;
        if (!date) return;
        if (rpe === undefined || rpe === null || rpe === '') return;

        const value = Number(rpe);
        if (!isFinite(value)) return;

        const d = new Date(date);
        if (isNaN(d.getTime())) return;

        const key = toDateOnlyString(d);
        const current = rpeMap.get(key) || { sum: 0, count: 0 };
        current.sum += value;
        current.count += 1;
        rpeMap.set(key, current);
      });

      const labels = Array.from(rpeMap.keys()).sort();
      const data = labels.map((k) => {
        const { sum, count } = rpeMap.get(k);
        return count > 0 ? sum / count : 0;
      });

      return { labels, data };
    }

    function renderCharts() {
      const logs = loadLogs();

      // 週間ボリューム
      const weekly = buildWeeklyVolume(logs);
      const weeklyEmpty = document.getElementById('weeklyVolumeEmpty');
      const weeklyCanvas = document.getElementById('weeklyVolumeChart');

      if (!weekly.labels.length) {
        if (weeklyEmpty) weeklyEmpty.style.display = 'block';
      } else if (weeklyCanvas && window.Chart) {
        if (weeklyEmpty) weeklyEmpty.style.display = 'none';
        new Chart(weeklyCanvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: weekly.labels,
            datasets: [
              {
                label: '週間ボリューム（重量 × 回数）',
                data: weekly.data
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 0
                }
              },
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }

      // 1日平均RPE
      const daily = buildDailyAverageRpe(logs);
      const dailyEmpty = document.getElementById('dailyRpeEmpty');
      const dailyCanvas = document.getElementById('dailyRpeChart');

      if (!daily.labels.length) {
        if (dailyEmpty) dailyEmpty.style.display = 'block';
      } else if (dailyCanvas && window.Chart) {
        if (dailyEmpty) dailyEmpty.style.display = 'none';
        new Chart(dailyCanvas.getContext('2d'), {
          type: 'line',
          data: {
            labels: daily.labels,
            datasets: [
              {
                label: '1日平均 RPE',
                data: daily.data,
                tension: 0.25,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                suggestedMax: 10
              }
            }
          }
        });
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderCharts();
    });
  </script>
</body>
</html>