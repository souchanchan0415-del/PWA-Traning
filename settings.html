<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | システム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab active">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- プロフィール設定 -->
    <section class="card">
      <h2 class="card-title">プロフィール設定</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        ここでは、アプリ内で表示するあなたの名前を設定できます。<br>
        今後のアップデートで、ヘッダーや各画面のメッセージなどに反映していく予定です。
      </p>

      <form id="profileForm" class="form">
        <div class="field">
          <label for="displayName">表示名</label>
          <input
            type="text"
            id="displayName"
            placeholder="例）おさむ"
          >
        </div>
        <button type="submit" class="btn-primary">保存する</button>
        <p id="profileMessage" class="message"></p>
      </form>
    </section>

    <!-- データ管理 -->
    <section class="card">
      <h2 class="card-title">データ管理</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        ここでは、ワークアウトの記録データを確認したり、<br>
        バックアップ用にJSON形式でコピーしたりできます。
      </p>

      <p style="margin-top:8px; font-size:0.9rem; color:#c2c5d3;">
        現在のログ件数：<span id="logCount">0</span>件
      </p>

      <!-- JSON表示トグル -->
      <button type="button" id="toggleJsonBtn" class="btn-primary">
        ログJSONを表示
      </button>

      <!-- JSONコピー -->
      <button type="button" id="copyJsonBtn" class="btn-primary" style="margin-top:8px;">
        JSONをコピー
      </button>

      <p style="margin-top:6px; font-size:0.75rem; color:#a0a3b1;">
        ※コピー＆インポート用です。<br>
        ・バックアップ：「JSONをコピー」ボタンでクリップボードに保存できます。<br>
        ・復元：下の欄にJSONを貼り付けて「JSONから復元する」を押すと、ログを上書きします。
      </p>

      <!-- JSON表示エリア（読み取り専用） -->
      <textarea
        id="jsonOutput"
        rows="10"
        readonly
        style="margin-top:8px; display:none;"
        placeholder="ここにログJSONが表示されます"
      ></textarea>

      <!-- JSONインポート用 -->
      <textarea
        id="jsonInput"
        rows="6"
        style="margin-top:12px;"
        placeholder="ここにJSONを貼り付けて「JSONから復元する」を押すと、現在のログをこのJSONで上書きします。"
      ></textarea>

      <button type="button" id="importFromJsonBtn" class="btn-primary" style="margin-top:8px;">
        JSONから復元する
      </button>

      <button type="button" id="deleteAllLogsBtn" class="btn-danger" style="margin-top:12px;">
        すべてのログを削除する
      </button>
      <p style="margin-top:6px; font-size:0.75rem; color:#a0a3b1;">
        ※この操作は元に戻せません。ローカルに保存されているワークアウト記録がすべて消去されます。
      </p>
    </section>

    <!-- 種目プリセット（部位を選んで種目を追加） -->
    <section class="card">
      <h2 class="card-title">種目プリセット</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        ここでは、よく使う種目を部位ごとに追加できます。<br>
        追加した種目は、ワークアウト画面の部位タブに反映させていく予定です。
      </p>

      <form id="customExerciseForm" class="form" onsubmit="return false;">
        <div class="field-group">
          <div class="field">
            <label for="customExercisePart">部位</label>
            <select id="customExercisePart">
              <option value="chest">胸</option>
              <option value="back">背中</option>
              <option value="shoulder">肩</option>
              <option value="leg">脚</option>
              <option value="arm">腕</option>
              <option value="other">その他</option>
            </select>
          </div>
          <div class="field">
            <label for="customExerciseName">種目名</label>
            <input
              type="text"
              id="customExerciseName"
              placeholder="例）ダンベルフライ"
            >
          </div>
        </div>

        <button type="button" id="addCustomExerciseBtn" class="btn-primary">
          種目を追加する
        </button>
        <p id="customExerciseMessage" class="message"></p>
      </form>

      <div style="margin-top:12px;">
        <h3 style="margin:0 0 6px; font-size:0.95rem;">登録済みのカスタム種目</h3>
        <div id="customExerciseEmpty" class="empty">
          まだカスタム種目は登録されていません
        </div>

        <div class="table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>部位</th>
                <th>種目名</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="customExerciseTableBody"></tbody>
          </table>
        </div>

        <p style="margin-top:6px; font-size:0.75rem; color:#a0a3b1;">
          ※ここで削除しても、既に記録済みのワークアウトデータは消えません。<br>
          （新規入力時の候補から外れるだけです）
        </p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- ▼ 表示名 → ヘッダー反映用スクリプト ▼ -->
  <script>
    function getDisplayName() {
      return localStorage.getItem('trainPunchDisplayName') || '';
    }

    function applyDisplayNameToHeader() {
      const headerSub = document.querySelector('.header-sub');
      if (!headerSub) return;

      const name = getDisplayName();
      if (name) {
        headerSub.textContent =
          `トレーニング記録アプリ / ${name}のログ / ローカル保存版 v0.1`;
      } else {
        headerSub.textContent = 'トレーニング記録アプリ / ローカル保存版 v0.1';
      }
    }

    document.addEventListener('DOMContentLoaded', applyDisplayNameToHeader);
  </script>
  <!-- ▲ 表示名 → ヘッダー反映用スクリプト ▲ -->

  <script>
    // ---- 共通：ログ読み込み ---------------------------------------------
    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      } catch (_) {
        return null;
      }
    }

    function loadLogs() {
      const candidates = ['trainPunchLogs', 'train-punch-logs', 'TRAIN_PUNCH_LOGS'];
      for (const key of candidates) {
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      return [];
    }

    function saveLogs(logs) {
      localStorage.setItem('trainPunchLogs', JSON.stringify(logs));
    }

    // ---- カスタム種目保存用 ----------------------------------------------
    const CUSTOM_EXERCISES_KEY = 'trainPunchCustomExercises';
    const PART_LABELS = {
      chest: '胸',
      back: '背中',
      shoulder: '肩',
      leg: '脚',
      arm: '腕',
      other: 'その他'
    };

    function loadCustomExercises() {
      const raw = localStorage.getItem(CUSTOM_EXERCISES_KEY);
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch (_) {
        return {};
      }
    }

    function saveCustomExercises(map) {
      localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(map));
    }

    function renderCustomExerciseTable() {
      const tbody = document.getElementById('customExerciseTableBody');
      const emptyEl = document.getElementById('customExerciseEmpty');
      if (!tbody) return;

      const map = loadCustomExercises();
      const rows = [];

      Object.keys(map).forEach(partKey => {
        const list = Array.isArray(map[partKey]) ? map[partKey] : [];
        list.forEach(name => {
          rows.push({ partKey, name });
        });
      });

      tbody.innerHTML = '';

      if (!rows.length) {
        if (emptyEl) emptyEl.style.display = 'block';
        return;
      }
      if (emptyEl) emptyEl.style.display = 'none';

      rows.forEach(row => {
        const tr = document.createElement('tr');
        const partLabel = PART_LABELS[row.partKey] || 'その他';

        tr.innerHTML = `
          <td>${partLabel}</td>
          <td>${row.name}</td>
          <td>
            <button
              type="button"
              class="btn-danger small"
              data-part="${row.partKey}"
              data-name="${row.name}"
            >
              削除
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // 削除ボタン
      tbody.querySelectorAll('button[data-part]').forEach(btn => {
        btn.addEventListener('click', () => {
          const partKey = btn.getAttribute('data-part');
          const name = btn.getAttribute('data-name');
          const map = loadCustomExercises();
          if (!map[partKey]) return;
          map[partKey] = map[partKey].filter(n => n !== name);
          if (!map[partKey].length) {
            delete map[partKey];
          }
          saveCustomExercises(map);
          renderCustomExerciseTable();
        });
      });
    }

    function initCustomExerciseForm() {
      const partSelect = document.getElementById('customExercisePart');
      const nameInput = document.getElementById('customExerciseName');
      const addBtn = document.getElementById('addCustomExerciseBtn');
      const msgEl = document.getElementById('customExerciseMessage');

      if (!partSelect || !nameInput || !addBtn) return;

      function setMessage(text, ok = true) {
        if (!msgEl) return;
        msgEl.textContent = text;
        msgEl.style.color = ok ? '#a0f0a0' : '#ffb3b3';
      }

      addBtn.addEventListener('click', () => {
        const partKey = partSelect.value;
        const name = (nameInput.value || '').trim();

        if (!name) {
          setMessage('種目名を入力してください。', false);
          return;
        }

        const map = loadCustomExercises();
        const list = Array.isArray(map[partKey]) ? map[partKey] : [];

        if (list.includes(name)) {
          setMessage('同じ種目が既に登録されています。', false);
          return;
        }

        list.push(name);
        map[partKey] = list;
        saveCustomExercises(map);

        nameInput.value = '';
        setMessage('種目を追加しました。', true);
        renderCustomExerciseTable();
      });

      // 初期描画
      renderCustomExerciseTable();
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ===== プロフィール設定 =====
      const profileForm = document.getElementById('profileForm');
      const displayNameInput = document.getElementById('displayName');
      const profileMessage = document.getElementById('profileMessage');

      // 初期値反映
      displayNameInput.value = getDisplayName();

      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = (displayNameInput.value || '').trim();
        localStorage.setItem('trainPunchDisplayName', name);
        applyDisplayNameToHeader();
        profileMessage.textContent = '表示名を保存しました。';
        setTimeout(() => {
          profileMessage.textContent = '';
        }, 2000);
      });

      // ===== データ管理 =====
      const logCountEl = document.getElementById('logCount');
      const toggleJsonBtn = document.getElementById('toggleJsonBtn');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      const jsonOutput = document.getElementById('jsonOutput');
      const jsonInput = document.getElementById('jsonInput');
      const importFromJsonBtn = document.getElementById('importFromJsonBtn');
      const deleteAllLogsBtn = document.getElementById('deleteAllLogsBtn');

      let logs = loadLogs();

      function updateLogCount() {
        logCountEl.textContent = logs.length;
      }

      function refreshJsonOutput(show) {
        if (show) {
          jsonOutput.style.display = 'block';
          jsonOutput.value = JSON.stringify(logs, null, 2);
          toggleJsonBtn.textContent = 'ログJSONを隠す';
        } else {
          jsonOutput.style.display = 'none';
          toggleJsonBtn.textContent = 'ログJSONを表示';
        }
      }

      updateLogCount();
      refreshJsonOutput(false);

      // JSON表示トグル
      toggleJsonBtn.addEventListener('click', () => {
        const willShow = jsonOutput.style.display === 'none' || jsonOutput.style.display === '';
        if (willShow) {
          // 最新ログを再取得して表示
          logs = loadLogs();
        }
        refreshJsonOutput(willShow);
      });

      // JSONコピー
      copyJsonBtn.addEventListener('click', async () => {
        logs = loadLogs();
        const text = JSON.stringify(logs, null, 2);

        if (!text || text === '[]') {
          alert('コピーできるログがありません。');
          return;
        }

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const temp = document.createElement('textarea');
            temp.value = text;
            temp.style.position = 'fixed';
            temp.style.top = '-9999px';
            document.body.appendChild(temp);
            temp.focus();
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
          }
          alert('ログJSONをコピーしました。');
        } catch (err) {
          console.error(err);
          alert('コピーに失敗しました。表示されたJSONを手動で選択してコピーしてください。');
        }
      });

      // JSONから復元
      importFromJsonBtn.addEventListener('click', () => {
        const raw = jsonInput.value.trim();
        if (!raw) {
          alert('JSONが入力されていません。');
          return;
        }

        let parsed;
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          alert('JSONの形式として読み取れませんでした。内容を確認してください。');
          return;
        }

        if (!Array.isArray(parsed)) {
          alert('配列(JSONの先頭が [ で始まる形) のデータを貼り付けてください。');
          return;
        }

        const ok = confirm(
          '現在のログを、貼り付けたJSONの内容で上書きします。よろしいですか？'
        );
        if (!ok) return;

        logs = parsed;
        saveLogs(logs);
        updateLogCount();
        if (jsonOutput.style.display !== 'none') {
          jsonOutput.value = JSON.stringify(logs, null, 2);
        }
        alert('JSONから復元しました。');
      });

      // すべて削除
      deleteAllLogsBtn.addEventListener('click', () => {
        const ok = confirm(
          '本当にすべてのログを削除しますか？この操作は元に戻せません。'
        );
        if (!ok) return;

        logs = [];
        saveLogs(logs);
        updateLogCount();
        jsonOutput.value = '';
        jsonInput.value = '';
        alert('すべてのログを削除しました。');
      });

      // ===== カスタム種目 =====
      initCustomExerciseForm();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>