<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | システム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab active">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- プロフィール設定 -->
    <section class="card">
      <h2 class="card-title">プロフィール設定</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        ここでは、アプリ内で表示するあなたの名前を設定できます。<br>
        今後のアップデートで、ヘッダーや各画面のメッセージなどに反映していく予定です。
      </p>

      <form id="profileForm" class="form">
        <div class="field">
          <label for="displayName">表示名</label>
          <input
            type="text"
            id="displayName"
            placeholder="例）おさむ"
          >
        </div>
        <button type="submit" class="btn-primary">保存する</button>
        <p id="profileMessage" class="message"></p>
      </form>
    </section>

    <!-- データ管理 -->
    <section class="card">
      <h2 class="card-title">データ管理</h2>
      <p style="font-size:0.9rem; color:#c2c5d3;">
        ここでは、ワークアウトの記録データを確認したり、<br>
        バックアップ用にJSON形式でコピーしたりできます。
      </p>

      <p style="margin-top:8px; font-size:0.9rem; color:#c2c5d3;">
        現在のログ件数：<span id="logCount">0</span>件
      </p>

      <!-- JSON表示トグル -->
      <button type="button" id="toggleJsonBtn" class="btn-primary">
        ログJSONを表示
      </button>

      <!-- JSONコピー -->
      <button type="button" id="copyJsonBtn" class="btn-primary" style="margin-top:8px;">
        JSONをコピー
      </button>

      <p style="margin-top:6px; font-size:0.75rem; color:#a0a3b1;">
        ※コピー＆インポート用です。<br>
        ・バックアップ：「JSONをコピー」ボタンでクリップボードに保存できます。<br>
        ・復元：下の欄にJSONを貼り付けて「JSONから復元する」を押すと、ログを上書きします。
      </p>

      <!-- JSON表示エリア（読み取り専用） -->
      <textarea
        id="jsonOutput"
        rows="10"
        readonly
        style="margin-top:8px; display:none;"
        placeholder="ここにログJSONが表示されます"
      ></textarea>

      <!-- JSONインポート用 -->
      <textarea
        id="jsonInput"
        rows="6"
        style="margin-top:12px;"
        placeholder="ここにJSONを貼り付けて「JSONから復元する」を押すと、現在のログをこのJSONで上書きします。"
      ></textarea>

      <button type="button" id="importFromJsonBtn" class="btn-primary" style="margin-top:8px;">
        JSONから復元する
      </button>

      <button type="button" id="deleteAllLogsBtn" class="btn-danger" style="margin-top:12px;">
        すべてのログを削除する
      </button>
      <p style="margin-top:6px; font-size:0.75rem; color:#a0a3b1;">
        ※この操作は元に戻せません。ローカルに保存されているワークアウト記録がすべて消去されます。
      </p>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- ▼ 表示名 → ヘッダー反映用スクリプト ▼ -->
  <script>
    function getDisplayName() {
      return localStorage.getItem('trainPunchDisplayName') || '';
    }

    function applyDisplayNameToHeader() {
      const headerSub = document.querySelector('.header-sub');
      if (!headerSub) return;

      const name = getDisplayName();
      if (name) {
        headerSub.textContent =
          `トレーニング記録アプリ / ${name}のログ / ローカル保存版 v0.1`;
      } else {
        headerSub.textContent = 'トレーニング記録アプリ / ローカル保存版 v0.1';
      }
    }

    document.addEventListener('DOMContentLoaded', applyDisplayNameToHeader);
  </script>
  <!-- ▲ 表示名 → ヘッダー反映用スクリプト ▲ -->

  <script>
    // ---- 共通：ログ読み込み ---------------------------------------------
    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      } catch (_) {
        return null;
      }
    }

    function loadLogs() {
      const candidates = ['trainPunchLogs', 'train-punch-logs', 'TRAIN_PUNCH_LOGS'];
      for (const key of candidates) {
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      return [];
    }

    function saveLogs(logs) {
      localStorage.setItem('trainPunchLogs', JSON.stringify(logs));
    }

    document.addEventListener('DOMContentLoaded', () => {
      // ===== プロフィール設定 =====
      const profileForm = document.getElementById('profileForm');
      const displayNameInput = document.getElementById('displayName');
      const profileMessage = document.getElementById('profileMessage');

      // 初期値反映
      displayNameInput.value = getDisplayName();

      profileForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = (displayNameInput.value || '').trim();
        localStorage.setItem('trainPunchDisplayName', name);
        applyDisplayNameToHeader();
        profileMessage.textContent = '表示名を保存しました。';
        setTimeout(() => {
          profileMessage.textContent = '';
        }, 2000);
      });

      // ===== データ管理 =====
      const logCountEl = document.getElementById('logCount');
      const toggleJsonBtn = document.getElementById('toggleJsonBtn');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      const jsonOutput = document.getElementById('jsonOutput');
      const jsonInput = document.getElementById('jsonInput');
      const importFromJsonBtn = document.getElementById('importFromJsonBtn');
      const deleteAllLogsBtn = document.getElementById('deleteAllLogsBtn');

      let logs = loadLogs();

      function updateLogCount() {
        logCountEl.textContent = logs.length;
      }

      function refreshJsonOutput(show) {
        if (show) {
          jsonOutput.style.display = 'block';
          jsonOutput.value = JSON.stringify(logs, null, 2);
          toggleJsonBtn.textContent = 'ログJSONを隠す';
        } else {
          jsonOutput.style.display = 'none';
          toggleJsonBtn.textContent = 'ログJSONを表示';
        }
      }

      updateLogCount();
      refreshJsonOutput(false);

      // JSON表示トグル
      toggleJsonBtn.addEventListener('click', () => {
        const willShow = jsonOutput.style.display === 'none' || jsonOutput.style.display === '';
        if (willShow) {
          // 最新ログを再取得して表示
          logs = loadLogs();
        }
        refreshJsonOutput(willShow);
      });

      // JSONコピー
      copyJsonBtn.addEventListener('click', async () => {
        // 常に最新をコピーしたいので、その都度読み込み
        logs = loadLogs();
        const text = JSON.stringify(logs, null, 2);

        if (!text || text === '[]') {
          alert('コピーできるログがありません。');
          return;
        }

        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            // 古いブラウザ向けフォールバック
            const temp = document.createElement('textarea');
            temp.value = text;
            temp.style.position = 'fixed';
            temp.style.top = '-9999px';
            document.body.appendChild(temp);
            temp.focus();
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
          }
          alert('ログJSONをコピーしました。');
        } catch (err) {
          console.error(err);
          alert('コピーに失敗しました。表示されたJSONを手動で選択してコピーしてください。');
        }
      });

      // JSONから復元
      importFromJsonBtn.addEventListener('click', () => {
        const raw = jsonInput.value.trim();
        if (!raw) {
          alert('JSONが入力されていません。');
          return;
        }

        let parsed;
        try {
          parsed = JSON.parse(raw);
        } catch (e) {
          alert('JSONの形式として読み取れませんでした。内容を確認してください。');
          return;
        }

        if (!Array.isArray(parsed)) {
          alert('配列(JSONの先頭が [ で始まる形) のデータを貼り付けてください。');
          return;
        }

        const ok = confirm(
          '現在のログを、貼り付けたJSONの内容で上書きします。よろしいですか？'
        );
        if (!ok) return;

        logs = parsed;
        saveLogs(logs);
        updateLogCount();
        // 表示中なら中身も更新
        if (jsonOutput.style.display !== 'none') {
          jsonOutput.value = JSON.stringify(logs, null, 2);
        }
        alert('JSONから復元しました。');
      });

      // すべて削除
      deleteAllLogsBtn.addEventListener('click', () => {
        const ok = confirm(
          '本当にすべてのログを削除しますか？この操作は元に戻せません。'
        );
        if (!ok) return;

        logs = [];
        saveLogs(logs);
        updateLogCount();
        jsonOutput.value = '';
        jsonInput.value = '';
        alert('すべてのログを削除しました。');
      });
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>