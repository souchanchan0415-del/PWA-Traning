<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | システム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#0b1016">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- システム画面用スタイル -->
  <style>
    .card-collapsible .card-header-row {
      cursor: pointer;
    }
    .card-toggle-icon {
      font-size: 1.2rem;
      color: var(--tp-muted);
    }
    .card-body {
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">トレーニング記録アプリ / ローカル保存版 v0.1</p>

    <nav class="tab-nav">
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./analysis.html" class="tab">パフォーマンス</a>
      <a href="./history.html" class="tab">アーカイブ</a>
      <a href="./settings.html" class="tab active">システム</a>
    </nav>
  </header>

  <main class="container">
    <!-- プロフィール設定（折りたたみ：初期状態・開） -->
    <section class="card card-collapsible">
      <div class="card-header-row card-toggle">
        <h2 class="card-title">プロフィール設定</h2>
        <span class="card-toggle-icon">−</span>
      </div>
      <div class="card-body" id="profileCardBody">
        <p style="font-size:0.9rem; color:var(--tp-muted);">
          ここでは、アプリ内で表示するあなたの名前を設定できます。<br>
          ヘッダーの「◯◯のログ」に反映されます。
        </p>

        <form id="profileForm" class="form">
          <div class="field">
            <label for="displayName">表示名</label>
            <input
              type="text"
              id="displayName"
              placeholder="例）おさむ"
            >
          </div>
          <button type="submit" class="btn-primary">保存する</button>
          <p id="profileMessage" class="message"></p>
        </form>
      </div>
    </section>

    <!-- データ管理（折りたたみ：初期状態・閉） -->
    <section class="card card-collapsible">
      <div class="card-header-row card-toggle">
        <h2 class="card-title">データ管理</h2>
        <span class="card-toggle-icon">＋</span>
      </div>
      <div class="card-body" id="dataCardBody" style="display:none;">
        <p style="font-size:0.9rem; color:var(--tp-muted);">
          ここでは、ワークアウトの記録データを確認したり、<br>
          バックアップ用にJSON形式でコピーしたりできます。
        </p>

        <p style="margin-top:8px; font-size:0.9rem; color:var(--tp-muted);">
          現在のログ件数：<span id="logCount">0</span>件
        </p>

        <!-- JSON表示トグル -->
        <button type="button" id="toggleJsonBtn" class="btn-primary">
          ログJSONを表示
        </button>

        <!-- JSONコピー -->
        <button type="button" id="copyJsonBtn" class="btn-primary" style="margin-top:8px;">
          JSONをコピー
        </button>

        <p style="margin-top:6px; font-size:0.75rem; color:var(--tp-muted);">
          ※コピー＆インポート用です。<br>
          ・バックアップ：「JSONをコピー」ボタンでクリップボードに保存できます。<br>
          ・復元：下の欄にJSONを貼り付けて「JSONから復元する」を押すと、ログを上書きします。
        </p>

        <!-- JSON表示エリア（読み取り専用） -->
        <textarea
          id="jsonOutput"
          rows="10"
          readonly
          style="margin-top:8px; display:none;"
          placeholder="ここにログJSONが表示されます"
        ></textarea>

        <!-- JSONインポート用 -->
        <textarea
          id="jsonInput"
          rows="6"
          style="margin-top:12px;"
          placeholder="ここにJSONを貼り付けて「JSONから復元する」を押すと、現在のログをこのJSONで上書きします。"
        ></textarea>

        <button type="button" id="importFromJsonBtn" class="btn-primary" style="margin-top:8px;">
          JSONから復元する
        </button>

        <button type="button" id="deleteAllLogsBtn" class="btn-danger" style="margin-top:12px;">
          すべてのログを削除する
        </button>
        <p style="margin-top:6px; font-size:0.75rem; color:var(--tp-muted);">
          ※この操作は元に戻せません。ローカルに保存されているワークアウト記録がすべて消去されます。
        </p>
      </div>
    </section>

    <!-- 種目追加（旧：種目プリセット）（折りたたみ：初期状態・閉） -->
    <section class="card card-collapsible">
      <div class="card-header-row card-toggle">
        <h2 class="card-title">種目追加</h2>
        <span class="card-toggle-icon">＋</span>
      </div>
      <div class="card-body" id="exerciseCardBody" style="display:none;">
        <p style="font-size:0.9rem; color:var(--tp-muted);">
          よく使うオリジナル種目を登録しておくと、<br>
          ワークアウト画面の部位タブから選べるようになります。
        </p>

        <form id="exercisePresetForm" class="form" style="margin-top:8px;">
          <div class="field">
            <label for="exercisePartSelect">部位</label>
            <select id="exercisePartSelect">
              <option value="chest">胸</option>
              <option value="back">背中</option>
              <option value="shoulder">肩</option>
              <option value="leg">脚</option>
              <option value="arm">腕</option>
              <option value="other">その他</option>
            </select>
          </div>

          <div class="field">
            <label for="exerciseNameInput">種目名</label>
            <input
              type="text"
              id="exerciseNameInput"
              placeholder="例）ダンベルフライ"
            >
          </div>

          <button type="button" id="addExercisePresetBtn" class="btn-primary">
            種目を追加する
          </button>
          <p id="exercisePresetMessage" class="message"></p>
        </form>

        <div style="margin-top:16px;">
          <h3 style="font-size:0.95rem; margin:0 0 6px;">登録済みの種目</h3>
          <p style="font-size:0.8rem; color:var(--tp-muted); margin:0 0 6px;">
            種目名の右側の「×」で個別に削除できます。
          </p>
          <div id="customExerciseList" class="empty">
            まだカスタム種目は登録されていません。
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Train Punch のデータは、この端末のブラウザ(localStorage)に保存されます。</small>
  </footer>

  <!-- ▼ 表示名 → ヘッダー反映用スクリプト ▼ -->
  <script>
    function getDisplayName() {
      return localStorage.getItem('trainPunchDisplayName') || '';
    }

    function applyDisplayNameToHeader() {
      const headerSub = document.querySelector('.header-sub');
      if (!headerSub) return;

      const name = getDisplayName();
      if (name) {
        headerSub.textContent =
          `トレーニング記録アプリ / ${name}のログ / ローカル保存版 v0.1`;
      } else {
        headerSub.textContent = 'トレーニング記録アプリ / ローカル保存版 v0.1';
      }
    }
  </script>
  <!-- ▲ 表示名 → ヘッダー反映用スクリプト ▲ -->

  <script>
    // ---- 共通：ログ読み込み ---------------------------------------------
    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : null;
      } catch (_) {
        return null;
      }
    }

    function loadLogs() {
      const candidates = ['trainPunchLogs', 'train-punch-logs', 'TRAIN_PUNCH_LOGS'];
      for (const key of candidates) {
        const logs = tryParseArray(localStorage.getItem(key));
        if (logs) return logs;
      }
      return [];
    }

    function saveLogs(logs) {
      localStorage.setItem('trainPunchLogs', JSON.stringify(logs));
    }

    // ---- カスタム種目（session.html と共通のキー） ----------------------
    const CUSTOM_EXERCISES_KEY = 'trainPunchCustomExercises';

    function loadCustomExercises() {
      const raw = localStorage.getItem(CUSTOM_EXERCISES_KEY);
      if (!raw) return {};
      try {
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      } catch (_) {
        return {};
      }
    }

    function saveCustomExercises(map) {
      localStorage.setItem(CUSTOM_EXERCISES_KEY, JSON.stringify(map));
    }

    const PART_LABELS = {
      chest: '胸',
      back: '背中',
      shoulder: '肩',
      leg: '脚',
      arm: '腕',
      other: 'その他'
    };

    function renderCustomExerciseList() {
      const container = document.getElementById('customExerciseList');
      if (!container) return;

      const map = loadCustomExercises();
      const partKeys = Object.keys(map).filter(
        key => Array.isArray(map[key]) && map[key].length > 0
      );

      container.innerHTML = '';

      if (!partKeys.length) {
        container.classList.add('empty');
        container.textContent = 'まだカスタム種目は登録されていません。';
        return;
      }

      container.classList.remove('empty');

      partKeys.forEach(partKey => {
        const exercises = map[partKey];

        const groupDiv = document.createElement('div');
        groupDiv.style.marginBottom = '8px';

        const title = document.createElement('div');
        title.style.fontSize = '0.85rem';
        title.style.color = 'var(--tp-text)';
        title.style.marginBottom = '4px';
        title.textContent = PART_LABELS[partKey] || partKey;
        groupDiv.appendChild(title);

        exercises.forEach(name => {
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.justifyContent = 'space-between';
          row.style.gap = '8px';
          row.style.fontSize = '0.85rem';
          row.style.padding = '4px 8px';
          row.style.borderRadius = '6px';
          row.style.border = '1px solid var(--tp-border)';
          row.style.background = 'rgba(15, 23, 42, 0.95)';
          row.style.marginBottom = '4px';

          const labelSpan = document.createElement('span');
          labelSpan.textContent = name;

          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.textContent = '×';
          delBtn.className = 'btn-danger small';
          delBtn.style.padding = '2px 6px';
          delBtn.style.fontSize = '0.75rem';

          delBtn.addEventListener('click', () => {
            const ok = confirm(`「${name}」を削除しますか？`);
            if (!ok) return;

            const current = loadCustomExercises();
            if (Array.isArray(current[partKey])) {
              current[partKey] = current[partKey].filter(n => n !== name);
              if (current[partKey].length === 0) {
                delete current[partKey];
              }
              saveCustomExercises(current);
              renderCustomExerciseList();
            }
          });

          row.appendChild(labelSpan);
          row.appendChild(delBtn);
          groupDiv.appendChild(row);
        });

        container.appendChild(groupDiv);
      });
    }

    // ---- カード折りたたみ制御 ------------------------------------------
    function setupCardToggles() {
      const toggles = document.querySelectorAll('.card-toggle');
      toggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
          const card = toggle.closest('.card');
          if (!card) return;
          const body = card.querySelector('.card-body');
          const icon = toggle.querySelector('.card-toggle-icon');
          if (!body) return;

          const isHidden = body.style.display === 'none';
          body.style.display = isHidden ? 'block' : 'none';
          if (icon) {
            icon.textContent = isHidden ? '−' : '＋';
          }
        });
      });
    }

    // ---- 初期化 ---------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // ヘッダー表示名
      applyDisplayNameToHeader();

      // ===== プロフィール設定 =====
      const profileForm = document.getElementById('profileForm');
      const displayNameInput = document.getElementById('displayName');
      const profileMessage = document.getElementById('profileMessage');

      if (displayNameInput) {
        displayNameInput.value = getDisplayName();
      }

      if (profileForm) {
        profileForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const name = (displayNameInput.value || '').trim();
          localStorage.setItem('trainPunchDisplayName', name);
          applyDisplayNameToHeader();
          profileMessage.textContent = '表示名を保存しました。';
          setTimeout(() => {
            profileMessage.textContent = '';
          }, 2000);
        });
      }

      // ===== データ管理 =====
      const logCountEl = document.getElementById('logCount');
      const toggleJsonBtn = document.getElementById('toggleJsonBtn');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      const jsonOutput = document.getElementById('jsonOutput');
      const jsonInput = document.getElementById('jsonInput');
      const importFromJsonBtn = document.getElementById('importFromJsonBtn');
      const deleteAllLogsBtn = document.getElementById('deleteAllLogsBtn');

      let logs = loadLogs();

      function updateLogCount() {
        if (logCountEl) {
          logCountEl.textContent = logs.length;
        }
      }

      function refreshJsonOutput(show) {
        if (!jsonOutput || !toggleJsonBtn) return;

        if (show) {
          jsonOutput.style.display = 'block';
          jsonOutput.value = JSON.stringify(logs, null, 2);
          toggleJsonBtn.textContent = 'ログJSONを隠す';
        } else {
          jsonOutput.style.display = 'none';
          toggleJsonBtn.textContent = 'ログJSONを表示';
        }
      }

      updateLogCount();
      refreshJsonOutput(false);

      if (toggleJsonBtn) {
        toggleJsonBtn.addEventListener('click', () => {
          const willShow =
            jsonOutput.style.display === 'none' || jsonOutput.style.display === '';
          if (willShow) {
            logs = loadLogs();
          }
          refreshJsonOutput(willShow);
        });
      }

      if (copyJsonBtn) {
        copyJsonBtn.addEventListener('click', async () => {
          logs = loadLogs();
          const text = JSON.stringify(logs, null, 2);

          if (!text || text === '[]') {
            alert('コピーできるログがありません。');
            return;
          }

          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(text);
            } else {
              const temp = document.createElement('textarea');
              temp.value = text;
              temp.style.position = 'fixed';
              temp.style.top = '-9999px';
              document.body.appendChild(temp);
              temp.focus();
              temp.select();
              document.execCommand('copy');
              document.body.removeChild(temp);
            }
            alert('ログJSONをコピーしました。');
          } catch (err) {
            console.error(err);
            alert('コピーに失敗しました。表示されたJSONを手動で選択してコピーしてください。');
          }
        });
      }

      if (importFromJsonBtn) {
        importFromJsonBtn.addEventListener('click', () => {
          const raw = (jsonInput.value || '').trim();
          if (!raw) {
            alert('JSONが入力されていません。');
            return;
          }

          let parsed;
          try {
            parsed = JSON.parse(raw);
          } catch (e) {
            alert('JSONの形式として読み取れませんでした。内容を確認してください。');
            return;
          }

          if (!Array.isArray(parsed)) {
            alert('配列(JSONの先頭が [ で始まる形) のデータを貼り付けてください。');
            return;
          }

          const ok = confirm(
            '現在のログを、貼り付けたJSONの内容で上書きします。よろしいですか？'
          );
          if (!ok) return;

          logs = parsed;
          saveLogs(logs);
          updateLogCount();
          if (jsonOutput.style.display !== 'none') {
            jsonOutput.value = JSON.stringify(logs, null, 2);
          }
          alert('JSONから復元しました。');
        });
      }

      if (deleteAllLogsBtn) {
        deleteAllLogsBtn.addEventListener('click', () => {
          const ok = confirm(
            '本当にすべてのログを削除しますか？この操作は元に戻せません。'
          );
          if (!ok) return;

          logs = [];
          saveLogs(logs);
          updateLogCount();
          if (jsonOutput) jsonOutput.value = '';
          if (jsonInput) jsonInput.value = '';
          alert('すべてのログを削除しました。');
        });
      }

      // ===== 種目追加 =====
      const exercisePartSelect = document.getElementById('exercisePartSelect');
      const exerciseNameInput = document.getElementById('exerciseNameInput');
      const addExercisePresetBtn = document.getElementById('addExercisePresetBtn');
      const exercisePresetMessage = document.getElementById('exercisePresetMessage');

      function showExerciseMessage(text) {
        if (!exercisePresetMessage) return;
        exercisePresetMessage.textContent = text;
        setTimeout(() => {
          exercisePresetMessage.textContent = '';
        }, 2000);
      }

      if (addExercisePresetBtn) {
        addExercisePresetBtn.addEventListener('click', () => {
          const partKey = exercisePartSelect.value;
          const name = (exerciseNameInput.value || '').trim();

          if (!name) {
            showExerciseMessage('種目名を入力してください。');
            return;
          }

          const map = loadCustomExercises();
          if (!Array.isArray(map[partKey])) {
            map[partKey] = [];
          }
          if (map[partKey].includes(name)) {
            showExerciseMessage('同じ名前の種目がすでに登録されています。');
            return;
          }

          map[partKey].push(name);
          saveCustomExercises(map);
          exerciseNameInput.value = '';
          renderCustomExerciseList();
          showExerciseMessage('種目を追加しました。');
        });
      }

      // 初期描画
      renderCustomExerciseList();

      // カード折りたたみセットアップ
      setupCardToggles();
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>