<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | ブログ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- 必要になったらここに Google AdSense のコードを貼る -->
  <!-- 例）<script async src="...adsbygoogle.js?..."></script> など -->

  <!-- ブログ専用の軽いスタイル -->
  <style>
    .blog-post-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .blog-post-card {
      padding: 10px 12px;
      border-radius: 8px;
      background: #181b24;
      border: 1px solid #2a2e3b;
    }

    .blog-post-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 4px;
    }

    .blog-post-meta {
      font-size: 0.75rem;
      color: #a0a3b1;
      margin-bottom: 4px;
    }

    .blog-post-summary {
      font-size: 0.85rem;
      color: #e0e0e0;
      margin: 0;
    }

    .blog-post-body {
      font-size: 0.9rem;
      color: #e0e0e0;
      white-space: pre-wrap;
      line-height: 1.7;
    }

    .blog-back-link {
      display: inline-block;
      margin-top: 8px;
      font-size: 0.85rem;
      color: #4f8cff;
      text-decoration: none;
    }

    .blog-back-link:hover {
      text-decoration: underline;
    }

    .blog-empty {
      font-size: 0.85rem;
      color: #a0a3b1;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">Train Punch ブログ（β）</p>
  </header>

  <main class="container">
    <section class="card" id="blogListSection">
      <h2 class="card-title">記事一覧</h2>
      <div id="blogEmpty" class="blog-empty" style="display:none;">
        まだ記事がありません。しばらくお待ちください。
      </div>
      <div id="postList" class="blog-post-list"></div>
    </section>

    <section class="card" id="blogDetailSection" style="display:none;">
      <h2 class="card-title" id="detailTitle"></h2>
      <p class="blog-post-meta" id="detailMeta"></p>
      <div class="blog-post-body" id="detailBody"></div>
      <a href="./blog.html" class="blog-back-link">← 記事一覧に戻る</a>
    </section>
  </main>

  <footer class="footer">
    <small>© Train Punch</small>
  </footer>

  <script>
    const POSTS_JSON_URL = './posts.json';

    function getPostIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }

    function formatDate(dateStr) {
      // そのままでも良いけど、将来的に整形したくなった時用
      return dateStr;
    }

    function renderList(posts) {
      const listEl = document.getElementById('postList');
      const emptyEl = document.getElementById('blogEmpty');
      const listSection = document.getElementById('blogListSection');
      const detailSection = document.getElementById('blogDetailSection');

      if (!listEl || !emptyEl || !listSection || !detailSection) return;

      listSection.style.display = 'block';
      detailSection.style.display = 'none';

      listEl.innerHTML = '';

      if (!posts.length) {
        emptyEl.style.display = 'block';
        return;
      }

      emptyEl.style.display = 'none';

      // 日付の新しい順に並べ替え
      const sorted = [...posts].sort((a, b) => {
        if (a.date === b.date) return 0;
        return a.date < b.date ? 1 : -1;
      });

      sorted.forEach((post) => {
        const card = document.createElement('article');
        card.className = 'blog-post-card';

        const titleLink = document.createElement('a');
        titleLink.href = `./blog.html?id=${encodeURIComponent(post.id)}`;
        titleLink.className = 'blog-post-title';
        titleLink.textContent = post.title || '(無題)';

        const meta = document.createElement('p');
        meta.className = 'blog-post-meta';
        meta.textContent = post.date ? formatDate(post.date) : '';

        const summary = document.createElement('p');
        summary.className = 'blog-post-summary';
        summary.textContent = post.summary || '';

        card.appendChild(titleLink);
        card.appendChild(meta);
        card.appendChild(summary);

        listEl.appendChild(card);
      });
    }

    function renderDetail(posts, id) {
      const listSection = document.getElementById('blogListSection');
      const detailSection = document.getElementById('blogDetailSection');
      const titleEl = document.getElementById('detailTitle');
      const metaEl = document.getElementById('detailMeta');
      const bodyEl = document.getElementById('detailBody');

      if (!listSection || !detailSection || !titleEl || !metaEl || !bodyEl) return;

      const post = posts.find((p) => p.id === id);

      if (!post) {
        // 見つからなければ一覧表示にフォールバック
        renderList(posts);
        return;
      }

      listSection.style.display = 'none';
      detailSection.style.display = 'block';

      titleEl.textContent = post.title || '(無題)';
      metaEl.textContent = post.date ? formatDate(post.date) : '';
      bodyEl.textContent = post.body || '';

      // ページタイトルも記事タイトルに
      document.title = `${post.title || '記事'} | Train Punch ブログ`;
    }

    async function initBlog() {
      try {
        const res = await fetch(POSTS_JSON_URL, { cache: 'no-cache' });
        if (!res.ok) throw new Error('failed to load posts.json');
        const posts = await res.json();

        const postId = getPostIdFromUrl();
        if (postId) {
          renderDetail(posts, postId);
        } else {
          renderList(posts);
        }
      } catch (err) {
        console.error(err);
        const emptyEl = document.getElementById('blogEmpty');
        if (emptyEl) {
          emptyEl.style.display = 'block';
          emptyEl.textContent = '記事データの読み込みに失敗しました。時間をおいて再度お試しください。';
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initBlog();

      // SW登録（他ページと同じ）
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(console.error);
        });
      }
    });
  </script>
</body>
</html>