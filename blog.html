<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Train Punch | ブログ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#111111">
  <link rel="stylesheet" href="./style.css">
  <link rel="manifest" href="./manifest.webmanifest">

  <!-- ブログ専用の軽いスタイル -->
  <style>
    .blog-form-note {
      font-size: 0.8rem;
      color: #a0a3b1;
      margin-bottom: 8px;
    }

    .blog-post-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .blog-post {
      padding: 10px 12px;
      border-radius: 8px;
      background: #181b24;
      border: 1px solid #2a2e3b;
    }

    .blog-post-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .blog-post-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .blog-post-meta {
      font-size: 0.75rem;
      color: #a0a3b1;
      white-space: nowrap;
    }

    .blog-post-body {
      font-size: 0.85rem;
      color: #e0e0e0;
      margin: 4px 0 6px;
      white-space: pre-wrap; /* 改行維持 */
    }

    .blog-post-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .btn-secondary {
      background: #2a2e3b;
      border: 1px solid #2a2e3b;
      color: #f5f5f5;
      cursor: pointer;
      font-weight: 500;
    }

    .btn-secondary.small,
    .btn-danger.small {
      width: auto;
      padding: 4px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    .blog-empty {
      font-size: 0.85rem;
      color: #a0a3b1;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>Train Punch</h1>
    <p class="header-sub">Train Punch ブログ（β）</p>

    <!-- あとで増やしたくなったらタブナビ入れてもOK
    <nav class="tab-nav">
      <a href="./index.html" class="tab">ホーム</a>
      <a href="./session.html" class="tab">ワークアウト</a>
      <a href="./shop.html" class="tab">ショップ</a>
      <a href="./blog.html" class="tab active">ブログ</a>
    </nav>
    -->
  </header>

  <main class="container">
    <!-- 記事作成フォーム -->
    <section class="card">
      <div class="card-header-row">
        <h2 class="card-title">新しい記事を書く</h2>
        <span id="editModeLabel" style="font-size:0.8rem; color:#f4c542; display:none;">
          編集モード
        </span>
      </div>

      <p class="blog-form-note">
        ここで書いた記事は、この端末のブラウザ（localStorage）にだけ保存されます。<br>
        公開用のブログというより、「自分用メモ」「記事下書きノート」的なイメージです。
      </p>

      <form id="postForm" class="form">
        <input type="hidden" id="postId">

        <div class="field">
          <label for="postTitle">タイトル</label>
          <input type="text" id="postTitle" placeholder="例：11月のトレーニング振り返り" required>
        </div>

        <div class="field">
          <label for="postBody">本文</label>
          <textarea
            id="postBody"
            rows="6"
            placeholder="今日のメモや、考えたこと、メニュー案などを自由に書いてください。"
            required
          ></textarea>
        </div>

        <div class="field-group">
          <button type="submit" id="saveBtn" class="btn-primary" style="flex:1;">
            保存する
          </button>
          <button type="button" id="cancelEditBtn" class="btn-secondary" style="flex:1; display:none;">
            編集をやめる
          </button>
        </div>

        <p id="formMessage" class="message"></p>
      </form>
    </section>

    <!-- 記事一覧 -->
    <section class="card">
      <div class="card-header-row">
        <h2 class="card-title">記事一覧</h2>
        <span id="postCountLabel" style="margin-left:auto; font-size:0.85rem; color:#c2c5d3;"></span>
      </div>

      <div id="blogEmpty" class="blog-empty" style="display:none;">
        まだ記事がありません。上のフォームから最初の記事を書いてみましょう。
      </div>

      <div id="postList" class="blog-post-list"></div>
    </section>
  </main>

  <footer class="footer">
    <small>© Train Punch</small>
  </footer>

  <script>
    // ---- localStorage 読み書き -------------------------------------------------

    function tryParseArray(raw) {
      if (!raw) return null;
      try {
        const v = JSON.parse(raw);
        return Array.isArray(v) ? v : null;
      } catch (_) {
        return null;
      }
    }

    function loadPosts() {
      // 将来キー名を変えた時用に一応候補を用意
      const candidates = ['trainPunchBlogPosts', 'TRAIN_PUNCH_BLOG_POSTS'];
      for (const key of candidates) {
        const data = tryParseArray(localStorage.getItem(key));
        if (data) return data;
      }
      return [];
    }

    function savePosts(posts) {
      localStorage.setItem('trainPunchBlogPosts', JSON.stringify(posts));
    }

    // ---- 状態 -------------------------------------------------------------

    let posts = loadPosts();
    let editingId = null; // null なら新規、数字ならそのIDを編集

    // ---- 描画 --------------------------------------------------------------

    function formatDateTime(ts) {
      const d = new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    function renderPosts() {
      const listEl = document.getElementById('postList');
      const emptyEl = document.getElementById('blogEmpty');
      const countLabel = document.getElementById('postCountLabel');
      if (!listEl || !emptyEl || !countLabel) return;

      listEl.innerHTML = '';

      if (!posts.length) {
        emptyEl.style.display = 'block';
        countLabel.textContent = '';
        return;
      }

      emptyEl.style.display = 'none';
      countLabel.textContent = `${posts.length}件`;

      // 新しい順に並べる
      const sorted = [...posts].sort((a, b) => b.createdAt - a.createdAt);

      sorted.forEach((post) => {
        const article = document.createElement('article');
        article.className = 'blog-post';
        article.dataset.id = String(post.id);

        const header = document.createElement('div');
        header.className = 'blog-post-header';

        const titleEl = document.createElement('div');
        titleEl.className = 'blog-post-title';
        titleEl.textContent = post.title || '(無題)';

        const metaEl = document.createElement('div');
        metaEl.className = 'blog-post-meta';
        const created = formatDateTime(post.createdAt);
        const updated = post.updatedAt && post.updatedAt !== post.createdAt
          ? ` / 更新: ${formatDateTime(post.updatedAt)}`
          : '';
        metaEl.textContent = `作成: ${created}${updated}`;

        header.appendChild(titleEl);
        header.appendChild(metaEl);

        const bodyEl = document.createElement('div');
        bodyEl.className = 'blog-post-body';
        bodyEl.textContent = post.body || '';

        const actions = document.createElement('div');
        actions.className = 'blog-post-actions';

        const editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.textContent = '編集';
        editBtn.className = 'btn-secondary small';
        editBtn.addEventListener('click', () => openEdit(post.id));

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.textContent = '削除';
        delBtn.className = 'btn-danger small';
        delBtn.addEventListener('click', () => deletePost(post.id));

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        article.appendChild(header);
        article.appendChild(bodyEl);
        article.appendChild(actions);

        listEl.appendChild(article);
      });
    }

    // ---- 編集系 ------------------------------------------------------------

    function resetForm() {
      const postId = document.getElementById('postId');
      const title = document.getElementById('postTitle');
      const body = document.getElementById('postBody');
      const msg = document.getElementById('formMessage');
      const editLabel = document.getElementById('editModeLabel');
      const cancelBtn = document.getElementById('cancelEditBtn');
      const saveBtn = document.getElementById('saveBtn');

      editingId = null;
      if (postId) postId.value = '';
      if (title) title.value = '';
      if (body) body.value = '';
      if (msg) msg.textContent = '';
      if (editLabel) editLabel.style.display = 'none';
      if (cancelBtn) cancelBtn.style.display = 'none';
      if (saveBtn) saveBtn.textContent = '保存する';
    }

    function openEdit(id) {
      const post = posts.find((p) => p.id === id);
      if (!post) return;

      editingId = id;

      const postId = document.getElementById('postId');
      const title = document.getElementById('postTitle');
      const body = document.getElementById('postBody');
      const msg = document.getElementById('formMessage');
      const editLabel = document.getElementById('editModeLabel');
      const cancelBtn = document.getElementById('cancelEditBtn');
      const saveBtn = document.getElementById('saveBtn');

      if (postId) postId.value = String(post.id);
      if (title) title.value = post.title || '';
      if (body) body.value = post.body || '';
      if (msg) msg.textContent = '';
      if (editLabel) editLabel.style.display = 'inline';
      if (cancelBtn) cancelBtn.style.display = 'inline-block';
      if (saveBtn) saveBtn.textContent = '更新する';

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deletePost(id) {
      const target = posts.find((p) => p.id === id);
      const title = target && target.title ? `「${target.title}」` : '';
      if (!confirm(`${title} を削除しますか？`)) return;

      posts = posts.filter((p) => p.id !== id);
      savePosts(posts);
      renderPosts();

      // 編集中のものを消した場合はフォームもリセット
      if (editingId === id) {
        resetForm();
      }
    }

    // ---- 初期化 ------------------------------------------------------------

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('postForm');
      const cancelBtn = document.getElementById('cancelEditBtn');
      const msg = document.getElementById('formMessage');

      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();

          const titleEl = document.getElementById('postTitle');
          const bodyEl = document.getElementById('postBody');

          const title = (titleEl.value || '').trim();
          const body = (bodyEl.value || '').trim();

          if (!title || !body) {
            msg.textContent = 'タイトルと本文は必須です。';
            msg.style.color = '#ff9b9b';
            return;
          }

          const now = Date.now();

          if (editingId != null) {
            // 既存記事の更新
            const idx = posts.findIndex((p) => p.id === editingId);
            if (idx >= 0) {
              posts[idx] = {
                ...posts[idx],
                title,
                body,
                updatedAt: now
              };
            }
            msg.textContent = '記事を更新しました。';
          } else {
            // 新規追加
            const newPost = {
              id: now,
              title,
              body,
              createdAt: now,
              updatedAt: now
            };
            posts.push(newPost);
            msg.textContent = '記事を保存しました。';
          }

          msg.style.color = '#a0f0a0';
          savePosts(posts);
          renderPosts();
          resetForm();
        });
      }

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          resetForm();
        });
      }

      renderPosts();

      // SW登録（他ページと同じ）
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(console.error);
        });
      }
    });
  </script>
</body>
</html>
